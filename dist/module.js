define(["@grafana/data","@grafana/runtime","@grafana/ui","lodash","react","rxjs"],((e,t,n,a,r,i)=>(()=>{"use strict";var l=[e=>{e.exports=r},e=>{e.exports=n},t=>{t.exports=e},e=>{e.exports=a},,e=>{e.exports=t},e=>{e.exports=i}],o={};function u(e){var t=o[e];if(void 0!==t)return t.exports;var n=o[e]={exports:{}};return l[e](n,n.exports,u),n.exports}u.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return u.d(t,{a:t}),t},u.d=(e,t)=>{for(var n in t)u.o(t,n)&&!u.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},u.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),u.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var s={};return(()=>{u.r(s),u.d(s,{plugin:()=>pe});var e=u(2);function t(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function n(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){function e(t){var a=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),n(this,"$scope",void 0),n(this,"annotation",void 0),n(this,"datasource",void 0),this.$scope=t,this.annotation=t.ctrl.annotation,this.datasource=t.ctrl.datasource,this.annotation.query=this.annotation.query||{},this.annotation.databases=this.annotation.databases||[],this.annotation.templates=this.annotation.templates||[],this.annotation.regex=this.annotation.regex||{},this.annotation.attribute=this.annotation.attribute||{},this.annotation.showEndTime=this.annotation.showEndTime||!1,this.datasource.getAssetServer(this.datasource.afserver.name).then((function(e){return a.getDatabases(e.WebId)}))}var a,r,i;return e.$inject=["$scope"],a=e,(r=[{key:"templateChanged",value:function(){}},{key:"databaseChanged",value:function(){this.annotation.templates=[],this.getEventFrames()}},{key:"getDatabases",value:function(e){var t=this,n=this;n.datasource.getDatabases(e).then((function(e){n.annotation.databases=e,t.$scope.$apply()}))}},{key:"getEventFrames",value:function(){var e=this,t=this;t.datasource.getEventFrameTemplates(this.annotation.database.WebId).then((function(n){t.annotation.templates=n,e.$scope.$apply()}))}}])&&t(a.prototype,r),i&&t(a,i),Object.defineProperty(a,"prototype",{writable:!1}),e}();n(a,"templateUrl","partials/annotations.editor.html");var r,i=u(0),l=u.n(i),o=u(1);function c(e){return c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},c(e)}function m(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function p(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function d(e,t){return d=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},d(e,t)}function h(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=b(e);if(t){var r=b(this).constructor;n=Reflect.construct(a,arguments,r)}else n=a.apply(this,arguments);return v(this,n)}}function v(e,t){if(t&&("object"===c(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return f(e)}function f(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function b(e){return b=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},b(e)}function g(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function y(){return y=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},y.apply(this,arguments)}var P,S,I=o.LegacyForms.FormField,E=function(e){return y({},e,{jsonData:y({},e.jsonData,{url:e.url})})},C=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&d(e,t)}(u,e);var t,n,a,i=h(u);function u(){var e;m(this,u);for(var t=arguments.length,n=new Array(t),a=0;a<t;a++)n[a]=arguments[a];return g(f(e=i.call.apply(i,[this].concat(n))),"onPIServerChange",(function(t){var n=e.props,a=n.onOptionsChange,r=n.options,i=y({},r.jsonData,{piserver:t.target.value});a(y({},r,{jsonData:i}))})),g(f(e),"onAFServerChange",(function(t){var n=e.props,a=n.onOptionsChange,r=n.options,i=y({},r.jsonData,{afserver:t.target.value});a(y({},r,{jsonData:i}))})),g(f(e),"onAFDatabaseChange",(function(t){var n=e.props,a=n.onOptionsChange,r=n.options,i=y({},r.jsonData,{afdatabase:t.target.value});a(y({},r,{jsonData:i}))})),g(f(e),"onMyOptionsChange",(function(t){(0,e.props.onOptionsChange)(E(t))})),e}return t=u,(n=[{key:"render",value:function(){var e=this.props.options,t=E(e);return l().createElement("div",null,l().createElement(o.DataSourceHttpSettings,{defaultUrl:"https://server.name/piwebapi",dataSourceConfig:t,onChange:this.onMyOptionsChange,showAccessOptions:!0}),r||(r=l().createElement("h3",{className:"page-heading"},"PI/AF Connection Details")),l().createElement("div",{className:"gf-form-group"},l().createElement("div",{className:"gf-form"},l().createElement(I,{label:"PI Server",labelWidth:10,inputWidth:25,onChange:this.onPIServerChange,value:t.jsonData.piserver||"",placeholder:"Default PI Server to use for data requests"})),l().createElement("div",{className:"gf-form"},l().createElement(I,{label:"AF Server",labelWidth:10,inputWidth:25,onChange:this.onAFServerChange,value:t.jsonData.afserver||"",placeholder:"Default AF Server to use for data requests"})),l().createElement("div",{className:"gf-form"},l().createElement(I,{label:"AF Database",labelWidth:10,inputWidth:25,onChange:this.onAFDatabaseChange,value:t.jsonData.afdatabase||"",placeholder:"Default AF Database server for AF queries"}))))}}])&&p(t.prototype,n),a&&p(t,a),Object.defineProperty(t,"prototype",{writable:!1}),u}(i.PureComponent),w=u(3);function x(){return x=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},x.apply(this,arguments)}var A=function(e){var t=e.label,n=e.labelWidth,a=void 0===n?12:n,r=e.tooltip,i=e.children;return l().createElement(l().Fragment,null,l().createElement(o.InlineFormLabel,{width:a,tooltip:r},t),i)},O=function(){return P||(P=l().createElement("div",{className:"gf-form gf-form--grow"},l().createElement("div",{className:"gf-form-label gf-form-label--grow"})))},V=function(e){var t=x({},e);return l().createElement(T,null,l().createElement(A,t))},T=function(e){return l().createElement("div",{className:"gf-form-inline"},e.children,S||(S=l().createElement(O,null)))},F=function(e){var t=x({},e);return l().createElement(N,null,l().createElement(A,t))},N=function(e){return l().createElement(l().Fragment,null,e.children)},j={target:";",attributes:[],segments:[],regex:{enable:!1},summary:{types:[],basis:"EventWeighted",interval:"",nodata:"Null"},expression:"",interpolate:{enable:!1},recordedValues:{enable:!1},digitalStates:{enable:!1},isPiPoint:!1};function k(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==n)return;var a,r,i=[],l=!0,o=!1;try{for(n=n.call(e);!(l=(a=n.next()).done)&&(i.push(a.value),!t||i.length!==t);l=!0);}catch(e){o=!0,r=e}finally{try{l||null==n.return||n.return()}finally{if(o)throw r}}return i}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return W(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return W(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function W(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,a=new Array(t);n<t;n++)a[n]=e[n];return a}var D,R,B=function(e){var t=e.isRaw,n=e.onChange,a=k((0,i.useState)(!1),2),r=a[0],u=a[1];return(0,i.useEffect)((function(){u(!1)}),[t]),t?l().createElement(l().Fragment,null,l().createElement(o.Button,{"aria-label":"Switch to visual editor",icon:"pen",variant:"secondary",type:"button",onClick:function(){u(!0)}}),l().createElement(o.ConfirmModal,{isOpen:r,title:"Switch to visual editor mode",body:"Are you sure to switch to visual editor mode? You will lose the changes done in raw query mode.",confirmText:"Yes, switch to editor mode",dismissText:"No, stay in raw query mode",onConfirm:function(){n(!1)},onDismiss:function(){u(!1)}})):l().createElement(o.Button,{"aria-label":"Switch to text editor",icon:"pen",variant:"secondary",type:"button",onClick:function(){n(!0)}})};function q(e){return q="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},q(e)}function G(){return G=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},G.apply(this,arguments)}function _(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function M(e,t){return M=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},M(e,t)}function Q(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=H(e);if(t){var r=H(this).constructor;n=Reflect.construct(a,arguments,r)}else n=a.apply(this,arguments);return $(this,n)}}function $(e,t){if(t&&("object"===q(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return U(e)}function U(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function H(e){return H=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},H(e)}function L(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var z=24,J=250,X="-REMOVE-",K=function(e){var t;return e.value?l().createElement("div",{className:"gf-form-label ".concat("template"===e.value.type?"query-keyword":"")},null!==(t=e.label)&&void 0!==t?t:"--no label--"):D||(D=l().createElement("a",{className:"gf-form-label query-part"},l().createElement(o.Icon,{name:"plus"})))},Y=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&M(e,t)}(i,e);var t,n,a,r=Q(i);function i(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,i),L(U(t=r.call(this,e)),"error",void 0),L(U(t),"piServer",[]),L(U(t),"availableAttributes",{}),L(U(t),"summaryTypes",void 0),L(U(t),"calculationBasis",void 0),L(U(t),"noDataReplacement",void 0),L(U(t),"state",{isPiPoint:!1,segments:[],attributes:[],summaries:[],attributeSegment:{},summarySegment:{},calculationBasisSegment:{},noDataReplacementSegment:{}}),L(U(t),"segmentChangeValue",(function(e){var n=t.props.query;t.setState({segments:e},(function(){return t.onChange(G({},n,{segments:e}))}))})),L(U(t),"attributeChangeValue",(function(e){var n=t.props.query;t.setState({attributes:e},(function(){return t.onChange(G({},n,{attributes:e}))}))})),L(U(t),"onPiPointChange",(function(e,n){var a=t.state.attributes.slice(0);e.label===X?(0,w.remove)(a,(function(e,t){return t===n})):a[n]=e,t.checkPiPointSegments(e,a)})),L(U(t),"onAttributeChange",(function(e,n){var a=t.state.attributes.slice(0);a[n]=e,t.checkAttributeSegments(a,t.state.segments)})),L(U(t),"onSegmentChange",(function(e,n){var a,r,i=t.props.query,l=t.state.segments.slice(0);return e.label===X?(l=(0,w.slice)(l,0,n),t.checkAttributeSegments([],l),0===l.length?l.push({label:""}):null!==(r=l[l.length-1].value)&&void 0!==r&&r.expandable&&l.push({label:"Select Element",value:{value:"-Select Element-"}}),i.isPiPoint&&(t.piServer=[]),void t.segmentChangeValue(l)):(l[n]=e,i.isPiPoint?(t.piServer.push(e),void t.segmentChangeValue(l)):(n<l.length-1&&(l=(0,w.slice)(l,0,n+1)),t.checkAttributeSegments([],l),null!==(a=e.value)&&void 0!==a&&a.expandable&&l.push({label:"Select Element",value:{value:"-Select Element-"}}),void t.segmentChangeValue(l)))})),L(U(t),"getElementSegments",(function(e,n){var a,r,i=t.props,l=i.datasource,o=i.query,u=i.data,s=U(t),c=o.isPiPoint?{type:"dataserver"}:{path:t.getSegmentPathUpTo(null!=n?n:t.state.segments.slice(0),e)};if(!o.isPiPoint){var m,p,d;if(null!==(m=l.afserver)&&void 0!==m&&m.name&&0===e)return Promise.resolve([{label:l.afserver.name,value:{value:l.afserver.name,expandable:!0}}]);if(null!==(p=l.afserver)&&void 0!==p&&p.name&&null!==(d=l.afdatabase)&&void 0!==d&&d.name&&1===e)return Promise.resolve([{label:l.afdatabase.name,value:{value:l.afdatabase.name,expandable:!0}}])}return l.metricFindQuery(c,Object.assign(null!==(a=null==u||null===(r=u.request)||void 0===r?void 0:r.scopedVars)&&void 0!==a?a:{},{isPiPoint:o.isPiPoint})).then((function(e){var t=(0,w.map)(e,(function(e){return{label:e.text,value:{webId:e.WebId,value:e.text,expandable:!o.isPiPoint&&e.expandable}}}));if(0===t.length)return t;var n=l.templateSrv.getVariables();return(0,w.each)(n,(function(e){var n={label:"${"+e.name+"}",value:{type:"template",value:"${"+e.name+"}",expandable:!o.isPiPoint}};t.unshift(n)})),t.unshift({label:X,value:{value:X}}),t})).catch((function(e){return s.error=e.message||"Failed to issue metric query",[]}))})),L(U(t),"getAttributeSegmentsPI",(function(e){var n,a,r=t.props,i=r.datasource,l=r.query,o=r.data,u=U(t),s={path:"",webId:t.getSelectedPIServer(),pointName:(null!=e?e:"")+"*",type:"pipoint"},c=[];return i.metricFindQuery(s,Object.assign(null!==(n=null==o||null===(a=o.request)||void 0===a?void 0:a.scopedVars)&&void 0!==n?n:{},{isPiPoint:l.isPiPoint})).then((function(t){return(c=(0,w.map)(t,(function(e){return{path:e.Path,label:e.text,value:{value:e.text,expandable:!1}}}))).unshift({label:e,value:{value:e,expandable:!1}}),c.unshift({label:X,value:{value:X}}),c})).catch((function(e){return u.error=e.message||"Failed to issue metric query",c}))})),L(U(t),"getAttributeSegmentsAF",(function(e){var n=U(t),a=[];return(0,w.forOwn)(n.availableAttributes,(function(e,t){var n={label:t,value:{value:t,expandable:!0}};a.push(n)})),a.unshift({label:X,value:{value:X}}),a})),L(U(t),"buildFromTarget",(function(e,n,a){var r=e.target.split(";"),i=r.length>0?r[0].split("\\"):[];return i.length>1||1===i.length&&""!==i[0]?(r.splice(0,1),(0,w.each)(i,(function(e,t){n.push({label:e,value:{value:e,expandable:!0}})})),(0,w.each)(r,(function(e,t){""!==e&&a.push({label:e,value:{value:e,expandable:!1}})})),t.getElementSegments(i.length+1,n).then((function(e){return e.length>0&&n.push({label:"Select Element",value:{value:"-Select Element-"}}),n}))):Promise.resolve(n)})),L(U(t),"checkAfServer",(function(){var e,n,a=t.props.datasource,r=[];null!==(e=a.afserver)&&void 0!==e&&e.name?(r.push({label:a.afserver.name,value:{value:a.afserver.name,expandable:!0}}),null!==(n=a.afdatabase)&&void 0!==n&&n.name&&r.push({label:a.afdatabase.name,value:{value:a.afdatabase.name,expandable:!0}}),r.push({label:"Select Element",value:{value:"-Select Element-"}})):r.push({label:""});return r})),L(U(t),"updateArray",(function(e,n,a,r,i){t.setState({segments:e,attributes:n,summaries:a,isPiPoint:r},(function(){return t.checkAttributeSegments(n,t.state.segments).then((function(){i&&i()}))}))})),L(U(t),"scopedVarsDone",!1),L(U(t),"componentDidMount",(function(){t.initialLoad(!1)})),L(U(t),"componentDidUpdate",(function(){var e,n,a,r=t.props.query;"Done"===(null===(e=t.props.data)||void 0===e?void 0:e.state)&&null!==(n=t.props.data)&&void 0!==n&&null!==(a=n.request)&&void 0!==a&&a.scopedVars&&!t.scopedVarsDone&&(t.scopedVarsDone=!0,t.initialLoad(!r.isPiPoint))})),L(U(t),"initialLoad",(function(e){var n,a,r,i=t.props.query,l=(0,w.defaults)(i,j),o=l.segments,u=l.attributes,s=l.summary,c=l.isPiPoint,m=e?[]:null!==(n=null==o?void 0:o.slice(0))&&void 0!==n?n:[],p=e?[]:null!==(a=null==u?void 0:u.slice(0))&&void 0!==a?a:[],d=null!==(r=null==s?void 0:s.types)&&void 0!==r?r:[];if(c||0!==m.length)c&&m.length>0&&(t.piServer=m);else{if(i.target&&i.target.length>0&&";"!==i.target)return p=[],void t.buildFromTarget(i,m,p).then((function(e){t.updateArray(e,p,d,c)})).catch((function(e){}));m=t.checkAfServer()}t.updateArray(m,p,d,c,(function(){t.onChange(i)}))})),L(U(t),"onChange",(function(e){var n,a=t.props,r=a.onChange,i=a.onRunQuery;if(e.summary.types=t.state.summaries,e.rawQuery){if(e.target=null!==(n=e.query)&&void 0!==n?n:"",""!==e.target){var l=e.target.split(";"),o=l[0].split("\\");l.splice(0,1),e.attributes=[],(o.length>1||1===o.length&&""!==o[0])&&(e.elementPath=o.join("\\"),(0,w.each)(l,(function(t,n){""!==t&&e.attributes.push({label:t,value:{value:t,expandable:!1}})})))}}else e.elementPath=t.getSegmentPathUpTo(t.state.segments,t.state.segments.length),e.target=e.elementPath+";"+(0,w.join)(e.attributes.map((function(e){var t;return null===(t=e.value)||void 0===t?void 0:t.value})),";");r(e),e.target&&e.target.length>0&&e.attributes.length>0&&i()})),L(U(t),"stateCallback",(function(){var e=t.props.query;t.onChange(e)})),L(U(t),"onIsPiPointChange",(function(e){var n=t.props.query,a=!n.isPiPoint;t.setState({segments:a?[{label:""}]:t.checkAfServer(),attributes:[],isPiPoint:a},(function(){t.onChange(G({},n,{expression:"",attributes:t.state.attributes,segments:t.state.segments,isPiPoint:a}))}))})),t.onSegmentChange=t.onSegmentChange.bind(U(t)),t.calcBasisValueChanged=t.calcBasisValueChanged.bind(U(t)),t.calcNoDataValueChanged=t.calcNoDataValueChanged.bind(U(t)),t.onSummaryAction=t.onSummaryAction.bind(U(t)),t.onSummaryValueChanged=t.onSummaryValueChanged.bind(U(t)),t.onAttributeAction=t.onAttributeAction.bind(U(t)),t.onAttributeChange=t.onAttributeChange.bind(U(t)),t.summaryTypes=["Total","Average","Minimum","Maximum","Range","StdDev","PopulationStdDev","Count","PercentGood","All","AllForNonNumeric"],t.calculationBasis=["TimeWeighted","EventWeighted","TimeWeightedContinuous","TimeWeightedDiscrete","EventWeightedExcludeMostRecentEvent","EventWeightedExcludeEarliestEvent","EventWeightedIncludeBothEnds"],t.noDataReplacement=["Null","Drop","Previous","0","Keep"],t}return t=i,(n=[{key:"isValueEmpty",value:function(e){return!e||!e.value||!e.value.length||e.value===X}},{key:"calcBasisValueChanged",value:function(e){var t,n=this.props.query,a=n.summary;a.basis=null===(t=e.value)||void 0===t?void 0:t.value,this.onChange(G({},n,{summary:a}))}},{key:"getCalcBasisSegments",value:function(){return(0,w.map)(this.calculationBasis,(function(e){return{label:e,value:{value:e,expandable:!0}}}))}},{key:"calcNoDataValueChanged",value:function(e){var t,n=this.props.query,a=n.summary;a.nodata=null===(t=e.value)||void 0===t?void 0:t.value,this.onChange(G({},n,{summary:a}))}},{key:"getNoDataSegments",value:function(){return(0,w.map)(this.noDataReplacement,(function(e){return{label:e,value:{value:e,expandable:!0}}}))}},{key:"onSummaryValueChanged",value:function(e,t){var n=this.state.summaries.slice(0);n[t]=e,this.isValueEmpty(e.value)&&n.splice(t,1),this.setState({summaries:n},this.stateCallback)}},{key:"getSummarySegments",value:function(){var e=this,t=(0,w.filter)(this.summaryTypes,(function(t){return-1===e.state.summaries.map((function(e){var t;return null===(t=e.value)||void 0===t?void 0:t.value})).indexOf(t)})),n=(0,w.map)(t,(function(e){return{label:e,value:{value:e,expandable:!0}}}));return n.unshift({label:X,value:{value:X}}),n}},{key:"removeSummary",value:function(e){var t=(0,w.filter)(this.state.summaries,(function(t){return t!==e}));this.setState({summaries:t})}},{key:"onSummaryAction",value:function(e){var t=this.state.summaries.slice(0);if(!this.isValueEmpty(e.value)){var n,a={label:e.label,value:{value:null===(n=e.value)||void 0===n?void 0:n.value,expandable:!0}};t.push(a)}this.setState({summarySegment:{},summaries:t},this.stateCallback)}},{key:"removeAttribute",value:function(e){var t=(0,w.filter)(this.state.attributes,(function(t){return t!==e}));this.attributeChangeValue(t)}},{key:"onAttributeAction",value:function(e){var t=this.props.query,n=this.state.attributes.slice(0);if(!this.isValueEmpty(e.value)){var a,r={label:e.label,value:{value:null===(a=e.value)||void 0===a?void 0:a.value,expandable:!t.isPiPoint}};n.push(r)}this.attributeChangeValue(n)}},{key:"getSegmentPathUpTo",value:function(e,t){var n=e.slice(0,t);return(0,w.reduce)(n,(function(e,t){var n;return t.value?null!==(n=t.value.value)&&void 0!==n&&n.startsWith("-Select")?e:e?e+"\\"+t.value.value:t.value.value:""}),"")}},{key:"checkAttributeSegments",value:function(e,t){var n,a,r=this,i=this.props,l=i.datasource,o=i.data,u=this,s={path:this.getSegmentPathUpTo(t.slice(0),t.length),type:"attributes"};return l.metricFindQuery(s,Object.assign(null!==(n=null==o||null===(a=o.request)||void 0===a?void 0:a.scopedVars)&&void 0!==n?n:{},{isPiPoint:!1})).then((function(t){var n={};(0,w.each)(t,(function(e){n[e.Path.substring(e.Path.indexOf("|")+1)]=e.WebId}));var a=(0,w.filter)(e,(function(e){var t,a=l.templateSrv.replace(null===(t=e.value)||void 0===t?void 0:t.value);return void 0!==n[a]}));u.availableAttributes=n,r.attributeChangeValue(a)})).catch((function(t){u.error=t.message||"Failed to issue metric query",r.attributeChangeValue(e)}))}},{key:"checkPiPointSegments",value:function(e,t){var n,a,r=this.props,i=r.datasource,l=r.data,o=this,u={path:e.path,webId:o.getSelectedPIServer(),pointName:e.label,type:"pipoint"};return i.metricFindQuery(u,Object.assign(null!==(n=null==l||null===(a=l.request)||void 0===a?void 0:a.scopedVars)&&void 0!==n?n:{},{isPiPoint:!0})).then((function(){o.attributeChangeValue(t)})).catch((function(e){o.error=e.message||"Failed to issue metric query",o.attributeChangeValue([])}))}},{key:"getSelectedPIServer",value:function(){var e,t=this,n="";return this.piServer.forEach((function(e){var a=t.props.query.target.split(";");a.length>=2&&a[0]===e.text&&(n=e.WebId)})),this.piServer.length>0?null===(e=this.piServer[0].value)||void 0===e?void 0:e.webId:n}},{key:"textEditorChanged",value:function(){var e=this,t=this.props,n=t.query,a=t.onChange,r=n.target.split(";"),i=r.length>0?r[0].split("\\"):[],l=[],o=[];i.length>1||1===i.length&&""!==i[0]?(r.splice(0,1),(0,w.each)(i,(function(e,t){l.push({label:e,value:{type:e.match(/\${\w+}/gi)?"template":void 0,value:e,expandable:!0}})})),this.getElementSegments(i.length+1,l).then((function(e){e.length>0&&l.push({label:"Select Element",value:{value:"-Select Element-"}})})),(0,w.each)(r,(function(e,t){""!==e&&o.push({label:e,value:{value:e,expandable:!1}})})),this.updateArray(l,o,this.state.summaries,n.isPiPoint,(function(){a(G({},n,{query:void 0,rawQuery:!1}))}))):(l=this.checkAfServer(),this.updateArray(l,this.state.attributes,this.state.summaries,n.isPiPoint,(function(){e.onChange(G({},n,{query:void 0,rawQuery:!1,attributes:e.state.attributes,segments:e.state.segments}))})))}},{key:"render",value:function(){var e=this,t=this.props,n=t.query,a=t.onChange,r=t.onRunQuery,i=(0,w.defaults)(n,j),u=i.interpolate,s=i.query,c=i.rawQuery,m=i.digitalStates,p=i.recordedValues,d=i.expression,h=i.isPiPoint,v=i.summary,f=i.display,b=i.regex;return l().createElement(l().Fragment,null,l().createElement(o.InlineField,{label:"Is Pi Point?",labelWidth:z},l().createElement(o.InlineSwitch,{value:h,onChange:this.onIsPiPointChange})),!!c&&l().createElement(o.InlineFieldRow,null,l().createElement(o.InlineField,{label:"Raw Query",labelWidth:z,grow:!0},l().createElement(o.Input,{onBlur:this.stateCallback,value:s,onChange:function(e){return a(G({},i,{query:e.target.value}))},placeholder:"enter query"})),l().createElement(B,{isRaw:!0,onChange:function(t){return e.textEditorChanged()}})),!c&&l().createElement(l().Fragment,null,l().createElement("div",{className:"gf-form-inline"},l().createElement(F,{label:h?"PI Server":"AF Elements",tooltip:h?"Select PI server.":"Select AF Element."},this.state.segments.map((function(t,n){return l().createElement(o.SegmentAsync,{key:"element-"+n,Component:l().createElement(K,{value:t.value,label:t.label}),onChange:function(t){return e.onSegmentChange(t,n)},loadOptions:function(t){return e.getElementSegments(n)},allowCustomValue:!0,inputMinWidth:200})})),R||(R=l().createElement(O,null)),!h&&l().createElement(B,{isRaw:!1,onChange:function(e){a(G({},i,{query:i.target,rawQuery:e}))}}))),l().createElement(V,{label:h?"Pi Points":"Attributes"},this.state.attributes.map((function(t,n){return h?l().createElement(o.SegmentAsync,{key:"attributes-"+n,Component:l().createElement(K,{value:t.value,label:t.label}),disabled:0===e.piServer.length,onChange:function(t){return e.onPiPointChange(t,n)},loadOptions:e.getAttributeSegmentsPI,reloadOptionsOnChange:!0,allowCustomValue:!0,inputMinWidth:J}):l().createElement(o.Segment,{key:"attributes-"+n,Component:l().createElement(K,{value:t.value,label:t.label}),disabled:e.state.segments.length<=2,onChange:function(t){return e.onAttributeChange(t,n)},options:e.getAttributeSegmentsAF(),allowCustomValue:!0,inputMinWidth:J})})),h&&l().createElement(o.SegmentAsync,{Component:l().createElement(K,{value:this.state.attributeSegment.value,label:this.state.attributeSegment.label}),disabled:0===this.piServer.length,onChange:this.onAttributeAction,loadOptions:this.getAttributeSegmentsPI,reloadOptionsOnChange:!0,allowCustomValue:!0,inputMinWidth:J}),!h&&l().createElement(o.Segment,{Component:l().createElement(K,{value:this.state.attributeSegment.value,label:this.state.attributeSegment.label}),disabled:this.state.segments.length<=2,onChange:this.onAttributeAction,options:this.getAttributeSegmentsAF(),allowCustomValue:!0,inputMinWidth:J}))),!h&&l().createElement(o.InlineField,{label:"Calculation",labelWidth:z,tooltip:"Modify all attributes by an equation. Use '.' for current item. Leave Attributes empty if you wish to perform element based calculations."},l().createElement(o.Input,{onBlur:r,value:d,onChange:function(t){return e.onChange(G({},i,{expression:t.target.value}))},placeholder:"'.'*2"})),l().createElement(o.InlineFieldRow,null,l().createElement(o.InlineField,{label:"Max Recorded Values",labelWidth:z,tooltip:"Maximum number of recorded value to retrive from the data archive, without using interpolation."},l().createElement(o.Input,{onBlur:r,value:p.maxNumber,onChange:function(t){return e.onChange(G({},i,{recordedValues:G({},p,{maxNumber:parseInt(t.target.value,10)})}))},type:"number",placeholder:"1000"})),l().createElement(o.InlineField,{label:"Recorded Values",labelWidth:z},l().createElement(o.InlineSwitch,{value:p.enable,onChange:function(){return e.onChange(G({},i,{recordedValues:G({},p,{enable:!p.enable})}))}})),l().createElement(o.InlineField,{label:"Digital States",labelWidth:z},l().createElement(o.InlineSwitch,{value:m.enable,onChange:function(){return e.onChange(G({},i,{digitalStates:G({},m,{enable:!m.enable})}))}}))),l().createElement(o.InlineFieldRow,null,l().createElement(o.InlineField,{label:"Interpolate Period",labelWidth:z,tooltip:"Override time between sampling, e.g. '30s'. Defaults to timespan/chart width."},l().createElement(o.Input,{onBlur:r,value:u.interval,onChange:function(t){return e.onChange(G({},i,{interpolate:G({},u,{interval:t.target.value})}))},placeholder:"30s"})),l().createElement(o.InlineField,{label:"Interpolate",labelWidth:z},l().createElement(o.InlineSwitch,{value:u.enable,onChange:function(){return e.onChange(G({},i,{interpolate:G({},u,{enable:!u.enable})}))}})),l().createElement(o.InlineField,{label:"Replace Bad Data",labelWidth:z,tooltip:"Replacement for bad quality values."},l().createElement(o.Segment,{Component:l().createElement(K,{value:{value:v.nodata},label:v.nodata}),onChange:this.calcNoDataValueChanged,options:this.getNoDataSegments(),allowCustomValue:!0}))),l().createElement(o.InlineFieldRow,null,l().createElement(o.InlineField,{label:"Summary Period",labelWidth:z,tooltip:"Override time between sampling, e.g. '30s'."},l().createElement(o.Input,{onBlur:r,value:v.interval,onChange:function(e){return a(G({},i,{summary:G({},v,{interval:e.target.value})}))},placeholder:"30s"})),l().createElement(o.InlineField,{label:"Basis",labelWidth:z,tooltip:"Defines the possible calculation options when performing summary calculations over time-series data."},l().createElement(o.Segment,{Component:l().createElement(K,{value:{value:v.basis},label:v.basis}),onChange:this.calcBasisValueChanged,options:this.getCalcBasisSegments(),allowCustomValue:!0})),l().createElement(o.InlineField,{label:"Summaries",labelWidth:z,tooltip:"Replacement for bad quality values."},l().createElement(o.InlineFieldRow,null,this.state.summaries.map((function(t,n){return l().createElement(o.Segment,{key:"summaries-"+n,Component:l().createElement(K,{value:t.value,label:t.label}),onChange:function(t){return e.onSummaryValueChanged(t,n)},options:e.getSummarySegments(),allowCustomValue:!0})})),l().createElement(o.Segment,{Component:l().createElement(K,{value:this.state.summarySegment.value,label:this.state.summarySegment.label}),onChange:this.onSummaryAction,options:this.getSummarySegments(),allowCustomValue:!0})))),l().createElement(o.InlineFieldRow,null,l().createElement(o.InlineField,{label:"Display Name",labelWidth:z,tooltip:"If single attribute, modify display name. Otherwise use regex to modify display name."},l().createElement(o.Input,{onBlur:r,value:f,onChange:function(t){return e.onChange(G({},i,{display:t.target.value}))},placeholder:"Display"})),l().createElement(o.InlineField,{label:"Enable Regex Replace",labelWidth:z},l().createElement(o.InlineSwitch,{value:b.enable,onChange:function(){e.onChange(G({},i,{regex:G({},b,{enable:!b.enable})}))}})),l().createElement(o.InlineField,{label:"Search",labelWidth:16},l().createElement(o.Input,{onBlur:r,value:b.search,onChange:function(t){return e.onChange(G({},i,{regex:G({},b,{search:t.target.value})}))},placeholder:"(.*)"})),l().createElement(o.InlineField,{label:"Replace",labelWidth:16},l().createElement(o.Input,{onBlur:r,value:b.replace,onChange:function(t){return e.onChange(G({},i,{regex:G({},b,{replace:t.target.value})}))},placeholder:"$1"}))))}}])&&_(t.prototype,n),a&&_(t,a),Object.defineProperty(t,"prototype",{writable:!1}),i}(i.PureComponent),Z=u(5),ee=u(6);function te(e){return te="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},te(e)}function ne(e){return function(e){if(Array.isArray(e))return ae(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return ae(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return ae(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ae(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,a=new Array(t);n<t;n++)a[n]=e[n];return a}function re(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function ie(e,t){return ie=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},ie(e,t)}function le(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=se(e);if(t){var r=se(this).constructor;n=Reflect.construct(a,arguments,r)}else n=a.apply(this,arguments);return oe(this,n)}}function oe(e,t){if(t&&("object"===te(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return ue(e)}function ue(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function se(e){return se=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},se(e)}function ce(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var me=function(t){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&ie(e,t)}(l,t);var n,a,r,i=le(l);function l(e){var t,n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,l),ce(ue(n=i.call(this,e)),"piserver",void 0),ce(ue(n),"afserver",void 0),ce(ue(n),"afdatabase",void 0),ce(ue(n),"basicAuth",void 0),ce(ue(n),"withCredentials",void 0),ce(ue(n),"url",void 0),ce(ue(n),"name",void 0),ce(ue(n),"isProxy",!1),ce(ue(n),"templateSrv",void 0),ce(ue(n),"backendSrv",void 0),ce(ue(n),"piwebapiurl",void 0),ce(ue(n),"webidCache",new Map),ce(ue(n),"error",void 0),n.basicAuth=e.basicAuth,n.withCredentials=e.withCredentials,n.url=e.url,n.name=e.name,n.templateSrv=(0,Z.getTemplateSrv)(),n.backendSrv=(0,Z.getBackendSrv)(),n.piwebapiurl=null===(t=e.jsonData.url)||void 0===t?void 0:t.toString(),n.isProxy=/^http(s)?:\/\//.test(n.url)||"proxy"===e.jsonData.access,n.piserver={name:(e.jsonData||{}).piserver,webid:void 0},n.afserver={name:(e.jsonData||{}).afserver,webid:void 0},n.afdatabase={name:(e.jsonData||{}).afdatabase,webid:void 0},Promise.all([n.getAssetServer(n.afserver.name).then((function(e){return n.afserver.webid=e.WebId})),n.getDataServer(n.piserver.name).then((function(e){return n.piserver.webid=e.WebId})),n.getDatabase(n.afserver.name?n.afserver.name+"\\"+n.afdatabase.name:void 0).then((function(e){return n.afdatabase.webid=e.WebId}))]),n}return n=l,(a=[{key:"eventFrameToAnnotation",value:function(e,t,n,a){e.regex&&e.regex.enable&&(n.Name=n.Name.replace(new RegExp(e.regex.search),e.regex.replace));var r="";return a&&(0,w.each)(a,(function(e){var t=e.Value.Value?e.Value.Value.Name||e.Value.Value.Value||e.Value.Value:null;r+="<br />"+e.Name+": "+t})),{annotation:e,title:(t?"END ":e.showEndTime?"START ":"")+e.name,time:new Date(t?n.EndTime:n.StartTime).getTime(),text:n.Name+r+"<br />Start: "+n.StartTime+"<br />End: "+n.EndTime}}},{key:"buildQueryParameters",value:function(e){var t=this;return e.targets=(0,w.filter)(e.targets,(function(e){return!(!e||!e.target||e.target.startsWith("Select AF"))})),e.targets=(0,w.map)(e.targets,(function(n){var a=t,r={target:t.templateSrv.replace(n.elementPath,e.scopedVars),elementPath:t.templateSrv.replace(n.elementPath,e.scopedVars),elementPathArray:[{path:t.templateSrv.replace(n.elementPath,e.scopedVars),variable:""}],attributes:(0,w.map)(n.attributes,(function(n){var a;return t.templateSrv.replace((null===(a=n.value)||void 0===a?void 0:a.value)||n,e.scopedVars)})),segments:(0,w.map)(n.segments,(function(n){var a;return t.templateSrv.replace(null===(a=n.value)||void 0===a?void 0:a.value,e.scopedVars)})),display:n.display,refId:n.refId,hide:n.hide,interpolate:n.interpolate||{enable:!1},recordedValues:n.recordedValues||{enable:!1},digitalStates:n.digitalStates||{enable:!1},webid:n.webid,webids:n.webids||[],regex:n.regex||{enable:!1},expression:n.expression||"",summary:n.summary||{types:[]},startTime:e.range.from,endTime:e.range.to,isPiPoint:n.isPiPoint,scopedVars:e.scopedVars};r.expression&&(r.expression=t.templateSrv.replace(r.expression,e.scopedVars)),void 0!==r.summary.types&&(r.summary.types=(0,w.filter)(r.summary.types,(function(e){return null!=e&&""!==e})));var i=(0,w.keys)(e.scopedVars);return t.templateSrv.getVariables().forEach((function(e){if(a.isAllSelected(e.current)&&i.indexOf(e.name)<0){var t=e.options.filter((function(e){return!e.selected}));r.attributes=r.attributes.map((function(n){return t.map((function(t){return e.allValue?n.replace(e.allValue,t.value):n.replace(/{[a-zA-z0-9,-_]+}/gi,t.value)}))})),r.attributes=(0,w.uniq)((0,w.flatten)(r.attributes)),r.elementPathArray=a.getElementPath(r.elementPathArray,t,e.allValue)}else if(Array.isArray(e.current.text)&&i.indexOf(e.name)<0){var n=e.options.filter((function(e){return e.selected})),l=e.current.value.join(",");r.attributes=r.attributes.map((function(e){return n.map((function(t){return e.replace("{".concat(l,"}"),t.value)}))})),r.attributes=(0,w.uniq)((0,w.flatten)(r.attributes)),r.elementPathArray=a.getElementPath(r.elementPathArray,n,"{".concat(l,"}"))}})),r})),e}},{key:"query",value:function(t){var n=this,a=this.buildQueryParameters(t);a.targets=(0,w.filter)(a.targets,(function(e){return!e.hide}));var r=1e3;a.maxDataPoints&&(r=a.maxDataPoints);var i=this.getStream(a).map((function(t){return new ee.Observable((function(a){t.then((function(t){var i=new e.CircularDataFrame({append:"tail",capacity:r});(0,w.each)(t,(function(t){if(i.refId=t.refId,i.name=t.target,i.addField({name:"time",type:e.FieldType.time}),i.addField({name:"value",type:e.FieldType.number}),t.WebId&&n.piwebapiurl){var r=n.piwebapiurl.replace(/(^\w+:|^)\/\//,"");r="ws://"+r+"/streams/"+t.WebId+"/channel?includeInitialValues=true";var l=new WebSocket(r);l.onerror=function(e){},l.onmessage=function(t){var n=JSON.parse(t.data),r=n.Items[0].Items[0].Timestamp,l=new Date(r).getTime(),o=n.Items[0].Items[0].Value;i.add({time:l,value:o}),a.next({data:[i],state:e.LoadingState.Streaming})}}(0,w.each)(t.datapoints,(function(e){i.add({time:e[1],value:e[0]})}))})),a.next({data:[i],state:e.LoadingState.Streaming})}))}))}));return ee.merge.apply(void 0,ne(i))}},{key:"testDatasource",value:function(){return this.backendSrv.datasourceRequest({url:this.url+"/",method:"GET"}).then((function(e){if(200===e.status)return{status:"success",message:"Data source is working",title:"Success"};throw new Error("Failed")}))}},{key:"annotationQuery",value:function(e){var t=this;if(!this.afdatabase.webid)return Promise.resolve([]);var n=e.annotation.query.categoryName?this.templateSrv.replace(e.annotation.query.categoryName,e.scopedVars,"glob"):null,a=e.annotation.query.nameFilter?this.templateSrv.replace(e.annotation.query.nameFilter,e.scopedVars,"glob"):null,r=e.annotation.template?e.annotation.template.Name:null,i={name:e.annotation.name,datasource:e.annotation.datasource,enable:e.annotation.enable,iconColor:e.annotation.iconColor,showEndTime:e.annotation.showEndTime,regex:e.annotation.regex,attribute:e.annotation.attribute,categoryName:n,templateName:r,nameFilter:a},l=[];if(i.categoryName&&l.push("categoryName="+i.categoryName),i.nameFilter&&l.push("nameFilter="+i.nameFilter),i.templateName&&l.push("templateName="+i.templateName),!l.length)return Promise.resolve([]);if(l.push("startTime="+e.range.from.toJSON()),l.push("endTime="+e.range.to.toJSON()),i.attribute&&i.attribute.enable){var o=this.piwebapiurl+"/streamsets/{0}/value?selectedFields=Items.WebId%3BItems.Value%3BItems.Name";i.attribute.name&&(o=this.piwebapiurl+"/streamsets/{0}/value?nameFilter="+i.attribute.name+"&selectedFields=Items.WebId%3BItems.Value%3BItems.Name");var u={};return u[1]={Method:"GET",Resource:this.piwebapiurl+"/assetdatabases/"+this.afdatabase.webid+"/eventframes?"+l.join("&")},u[2]={Method:"GET",RequestTemplate:{Resource:o},Parameters:["$.1.Content.Items[*].WebId"],ParentIds:["1"]},this.restBatch(u).then((function(n){var a=n.data[1].Content,r=n.data[2].Content,l=(0,w.map)(a.Items,(function(e,n){return(0,w.curry)(t.eventFrameToAnnotation)(i,!1,e,r.Items[n].Content.Items)}));if(e.annotation.showEndTime){var o=(0,w.map)(a.Items,(function(e,n){return(0,w.curry)(t.eventFrameToAnnotation)(i,!0,e,r.Items[n].Content.Items)}));(0,w.each)(o,(function(e){l.push(e)}))}return l}))}return this.restGet("/assetdatabases/"+this.afdatabase.webid+"/eventframes?"+l.join("&")).then((function(n){var a=(0,w.map)(n.data.Items,(0,w.curry)(t.eventFrameToAnnotation)(i,!1));if(e.annotation.showEndTime){var r=(0,w.map)(n.data.Items,(0,w.curry)(t.eventFrameToAnnotation)(i,!0));(0,w.each)(r,(function(e){a.push(e)}))}return a}))}},{key:"metricQueryTransform",value:function(e){return(0,w.map)(e,(function(e){var t,n;return{text:e.Name,expandable:void 0===e.HasChildren||!0===e.HasChildren||(null!==(t=e.Path)&&void 0!==t?t:"").split("\\").length<=3,HasChildren:e.HasChildren,Items:null!==(n=e.Items)&&void 0!==n?n:[],Path:e.Path,WebId:e.WebId}}))}},{key:"metricFindQuery",value:function(e,t){var n,a,r=this,i=["servers","databases","databaseElements","elements"];return"string"==typeof e&&(e=JSON.parse(e)),t.isPiPoint?e.path=this.templateSrv.replace(e.path,t):(""===e.path?e.type=i[0]:"attributes"!==e.type&&(e.type=i[Math.max(0,Math.min(e.path.split("\\").length,i.length-1))]),e.path=this.templateSrv.replace(e.path,t),e.path=e.path.replace(/\{([^\\])*\}/gi,(function(e){return e.substring(1,e.length-2).split(",")[0]}))),e.filter=null!==(n=e.filter)&&void 0!==n?n:"*","servers"===e.type?null!==(a=r.afserver)&&void 0!==a&&a.name?r.getAssetServer(r.afserver.name).then((function(e){return[e]})).then(r.metricQueryTransform):r.getAssetServers().then(r.metricQueryTransform):"databases"===e.type?r.getAssetServer(e.path).then((function(e){var t;return r.getDatabases(null!==(t=e.WebId)&&void 0!==t?t:"",{})})).then(r.metricQueryTransform):"databaseElements"===e.type?r.getDatabase(e.path).then((function(e){var t;return r.getDatabaseElements(null!==(t=e.WebId)&&void 0!==t?t:"",{selectedFields:"Items.WebId%3BItems.Name%3BItems.Items%3BItems.Path%3BItems.HasChildren"})})).then(r.metricQueryTransform):"elements"===e.type?r.getElement(e.path).then((function(t){var n;return r.getElements(null!==(n=t.WebId)&&void 0!==n?n:"",{selectedFields:"Items.WebId%3BItems.Name%3BItems.Items%3BItems.Path%3BItems.HasChildren",nameFilter:e.filter})})).then(r.metricQueryTransform):"attributes"===e.type?r.getElement(e.path).then((function(t){var n;return r.getAttributes(null!==(n=t.WebId)&&void 0!==n?n:"",{searchFullHierarchy:"true",selectedFields:"Items.WebId%3BItems.Name%3BItems.Path",nameFilter:e.filter})})).then(r.metricQueryTransform):"dataserver"===e.type?r.getDataServers().then(r.metricQueryTransform):"pipoint"===e.type?r.piPointSearch(e.webId,e.pointName).then(r.metricQueryTransform):Promise.reject("Bad type")}},{key:"getSummaryUrl",value:function(e){return""===e.interval.trim()?"&summaryType="+e.types.map((function(e){var t;return null===(t=e.value)||void 0===t?void 0:t.value})).join("&summaryType=")+"&calculationBasis="+e.basis:"&summaryType="+e.types.map((function(e){var t;return null===(t=e.value)||void 0===t?void 0:t.value})).join("&summaryType=")+"&calculationBasis="+e.basis+"&summaryDuration="+e.interval.trim()}},{key:"parsePiPointValueList",value:function(e,t,n){var a=this,r=this,i=[];return(0,w.each)(e,(function(e){var l=a.noDataReplace(n?e.Value:e,t.summary.nodata,r.parsePiPointValue(n?e.Value:e,t,n)),o=l.grafanaDataPoint;l.previousValue,l.drop||i.push(o)})),i}},{key:"parsePiPointValue",value:function(e,t,n){var a,r,i,l,o=n||"object"!==te(e.Value)?e.Value:null===(a=e.Value)||void 0===a?void 0:a.Value;return!e.Good||null!==(r=t.digitalStates)&&void 0!==r&&r.enable?(o=null!==(i=n||"object"!==te(e.Value)?e.Name:null===(l=e.Value)||void 0===l?void 0:l.Name)&&void 0!==i?i:"",[this.checkNumber(o)?Number(o):o.trim(),new Date(e.Timestamp).getTime()]):[this.checkNumber(o)?Number(o):o.trim(),new Date(e.Timestamp).getTime()]}},{key:"noDataReplace",value:function(e,t,n){var a,r,i=null,l=!1;return!e.Good||"No Data"===e.Value||null!==(a=e.Value)&&void 0!==a&&a.Name&&"No Data"===(null===(r=e.Value)||void 0===r?void 0:r.Name)?"Drop"===t?l=!0:"0"===t?n[0]=0:"Keep"===t||("Null"===t?n[0]=null:"Previous"===t&&null!==i&&(n[0]=i)):i=e.Value,{grafanaDataPoint:n,previousValue:i,drop:l}}},{key:"processResults",value:function(e,t,n,a){var r=this,i=t.summary&&t.summary.types&&t.summary.types.length>0;if(n=a?n:this.getPath(t.elementPathArray,e.Path)+"|"+n,t.regex&&t.regex.enable&&t.regex.search.length&&t.regex.replace.length&&(n=n.replace(new RegExp(t.regex.search),t.regex.replace)),i){var l=[],o=(0,w.groupBy)(e.Items,(function(e){return e.Type}));return(0,w.forOwn)(o,(function(a,o){l.push({refId:t.refId,target:n+"["+o+"]",WebId:e.WebId,datapoints:r.parsePiPointValueList(a,t,i)})})),l}return[{refId:t.refId,target:n,WebId:e.WebId,datapoints:r.parsePiPointValueList(e.Items,t,i)}]}},{key:"isAllSelected",value:function(e){return!!e&&(Array.isArray(e.text)?e.text.indexOf("All")>=0:"All"===e.text)}},{key:"checkNumber",value:function(e){return"number"==typeof e&&!Number.isNaN(e)&&Number.isFinite(e)}},{key:"getElementPath",value:function(e,t,n){var a=[];return e.forEach((function(e){if(n&&e.path.indexOf(n)>=0||!n&&e.path.match(/{[a-zA-z0-9,-_]+}/gi)){var r=t.map((function(t){return{path:n?e.path.replace(n,t.value):e.path.replace(/{[a-zA-z0-9,-_]+}/gi,t.value),variable:t.value}}));a=a.concat(r)}})),a.length?(0,w.uniq)((0,w.flatten)(a)):e}},{key:"getPath",value:function(e,t){var n,a,r=t.split("|");if(0===r.length)return"";if(0===e.length)return"";var i=0===(r=r[0].split("\\")).length?"":null!==(n=r.pop())&&void 0!==n?n:"",l=null===(a=e.find((function(e){return t.indexOf(e.path)>=0})))||void 0===a?void 0:a.variable;return l?l+"|"+i:i}},{key:"getStream",value:function(e){var t=this,n=this,a=[];return(0,w.each)(e.targets,(function(r){r.attributes=(0,w.filter)(r.attributes||[],(function(e){return e}));var i="",l=r.summary&&r.summary.types&&r.summary.types.length>0,o=r.interpolate&&r.interpolate.enable,u=r.interpolate.interval?r.interpolate.interval:e.interval,s="?startTime="+e.range.from.toJSON()+"&endTime="+e.range.to.toJSON(),c=r.expression||r.elementPath,m=r.display?t.templateSrv.replace(r.display,e.scopedVars):null;if(r.expression)i+="/calculation",i+=l?"/summary"+s+(o?"&sampleType=Interval&sampleInterval="+u:""):"/intervals"+s+"&sampleInterval="+u,i+="&expression="+encodeURIComponent(r.expression),r.attributes.length>0?a.push(n.internalStream(e,r,i)):a.push(n.restGetWebId(r.elementPath,r.isPiPoint).then((function(e){return n.restPost(i+e.WebId).then((function(e){return n.processResults(e.data,r,m||c,!1)})).catch((function(e){return n.error=e}))})));else{if(i+="/streamsets",l)i+="/summary"+s+"&intervals="+e.maxDataPoints+t.getSummaryUrl(r.summary);else if(r.interpolate&&r.interpolate.enable)i+="/interpolated"+s+"&interval="+u;else if(r.recordedValues&&r.recordedValues.enable){var p=r.recordedValues.maxNumber&&!isNaN(r.recordedValues.maxNumber)?r.recordedValues.maxNumber:1e3;i+="/recorded"+s+"&maxCount="+p}else i+="/plot"+s+"&intervals="+e.maxDataPoints;a.push(n.internalStream(e,r,i))}})),a}},{key:"internalStream",value:function(e,t,n){var a=this,r=t.expression||t.elementPath,i=t.display?this.templateSrv.replace(t.display,e.scopedVars):null,l=1===t.elementPathArray.length&&t.elementPath===t.elementPathArray[0].path;return(l?t.attributes.length>1&&!t.isPiPoint?a.restGetWebId(t.elementPath,t.isPiPoint).then((function(e){return a.getAttributes(e.WebId,{searchFullHierarchy:"true",nameFilter:"*"})})).then((function(e){return e.filter((function(e){var n;return t.attributes.indexOf(e.Name)>=0||t.attributes.indexOf(null===(n=e.Path)||void 0===n?void 0:n.split("|").splice(1).join("|"))>=0}))})):Promise.all((0,w.map)(t.attributes,(function(e){return a.restGetWebId(t.elementPath+"|"+e,t.isPiPoint)}))):t.attributes.length>1&&!t.isPiPoint?Promise.all(t.elementPathArray.map((function(e){return a.restGetWebId(e.path,t.isPiPoint).then((function(e){return a.getAttributes(e.WebId,{searchFullHierarchy:"true",nameFilter:"*"})})).then((function(e){return e.filter((function(e){var n;return t.attributes.indexOf(e.Name)>=0||t.attributes.indexOf(null===(n=e.Path)||void 0===n?void 0:n.split("|").splice(1).join("|"))>=0}))}))}))):Promise.all((0,w.flatten)((0,w.map)(t.attributes,(function(e){return t.elementPathArray.map((function(n){return a.restGetWebId(n.path+"|"+e,t.isPiPoint)}))}))))).then((function(e){var o={};return(0,w.each)((0,w.flatten)(e),(function(e,t){o[t+1]={Method:"GET",Resource:a.piwebapiurl+n+"&webid="+e.WebId}})),a.restBatch(o).then((function(n){var o=[];return(0,w.each)(n.data,(function(n,u){var s=e[parseInt(u,10)-1].WebId;if(t.expression){var c=e[parseInt(u,10)-1].Name;(0,w.each)(a.processResults(n.Content,t,i||c||r,l),(function(e){e.WebId=s,o.push(e)}))}else(0,w.each)(n.Content.Items,(function(e){(0,w.each)(a.processResults(e,t,i||e.Name||r,l),(function(e){e.WebId=s,o.push(e)}))}))})),o})).catch((function(e){return a.error=e}))}))}},{key:"restGet",value:function(e){return this.backendSrv.datasourceRequest({url:this.url+e,method:"GET",headers:{"Content-Type":"application/json"}}).then((function(e){return e}))}},{key:"restGetWebId",value:function(e,t){var n=this,a=n.webidCache.get(e);if(a)return Promise.resolve({Path:e,WebId:a.WebId,Name:a.Name});var r="";return r=t?"/points?selectedFields=WebId%3BName%3BPath&path=\\\\"+e.replace("|","\\"):(e.indexOf("|")>=0?"/attributes?selectedFields=WebId%3BName%3BPath&path=\\\\":"/elements?selectedFields=WebId%3BName%3BPath&path=\\\\")+e,this.backendSrv.datasourceRequest({url:this.url+r,method:"GET",headers:{"Content-Type":"application/json"}}).then((function(t){return n.webidCache.set(e,t.data),{Path:e,WebId:t.data.WebId,Name:t.data.Name}}))}},{key:"restBatch",value:function(e){return this.backendSrv.datasourceRequest({url:this.url+"/batch",data:e,method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"message/http"}})}},{key:"restPost",value:function(e){return this.backendSrv.datasourceRequest({url:this.url,method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"message/http","X-PIWEBAPI-HTTP-METHOD":"GET","X-PIWEBAPI-RESOURCE-ADDRESS":e}})}},{key:"getDataServers",value:function(){return this.restGet("/dataservers").then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}},{key:"getDataServer",value:function(e){return e?this.restGet("/dataservers?name="+e).then((function(e){return e.data})):Promise.resolve({})}},{key:"getAssetServers",value:function(){return this.restGet("/assetservers").then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}},{key:"getAssetServer",value:function(e){return e?this.restGet("/assetservers?path=\\\\"+e).then((function(e){return e.data})):Promise.resolve({})}},{key:"getDatabase",value:function(e){return e?this.restGet("/assetdatabases?path=\\\\"+e).then((function(e){return e.data})):Promise.resolve({})}},{key:"getDatabases",value:function(e,t){return e?this.restGet("/assetservers/"+e+"/assetdatabases").then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]})):Promise.resolve([])}},{key:"getElement",value:function(e){return e?this.restGet("/elements?path=\\\\"+e).then((function(e){return e.data})):Promise.resolve({})}},{key:"getEventFrameTemplates",value:function(e){return e?this.restGet("/assetdatabases/"+e+"/elementtemplates?selectedFields=Items.InstanceType%3BItems.Name%3BItems.WebId").then((function(e){var t;return(0,w.filter)(null!==(t=e.data.Items)&&void 0!==t?t:[],(function(e){return"EventFrame"===e.InstanceType}))})):Promise.resolve([])}},{key:"getElementTemplates",value:function(e){return e?this.restGet("/assetdatabases/"+e+"/elementtemplates?selectedFields=Items.InstanceType%3BItems.Name%3BItems.WebId").then((function(e){var t;return(0,w.filter)(null!==(t=e.data.Items)&&void 0!==t?t:[],(function(e){return"Element"===e.InstanceType}))})):Promise.resolve([])}},{key:"getAttributes",value:function(e,t){var n="?"+(0,w.map)(t,(function(e,t){return t+"="+e})).join("&");return"?"===n&&(n=""),this.restGet("/elements/"+e+"/attributes"+n).then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}},{key:"getDatabaseElements",value:function(e,t){var n="?"+(0,w.map)(t,(function(e,t){return t+"="+e})).join("&");return"?"===n&&(n=""),this.restGet("/assetdatabases/"+e+"/elements"+n).then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}},{key:"getElements",value:function(e,t){var n="?"+(0,w.map)(t,(function(e,t){return t+"="+e})).join("&");return"?"===n&&(n=""),this.restGet("/elements/"+e+"/elements"+n).then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}},{key:"piPointSearch",value:function(e,t){var n=this.templateSrv.replace(t),a="".concat(n),r=!1;if(n!==t)for(var i,l=/\{(\w|,)+\}/g;null!==(i=l.exec(n));)i.index===l.lastIndex&&l.lastIndex++,i.forEach((function(e,t){0===t&&(n=n.replace(e,e.replace("{","(").replace("}",")").replace(",","|")),a=a.replace(e,"*"),r=!0)}));return this.restGet("/dataservers/"+e+"/points?maxCount=20&nameFilter="+a).then((function(e){var t;return e&&null!==(t=e.data)&&void 0!==t&&t.Items?r?e.data.Items.filter((function(e){var t;return null===(t=e.Name)||void 0===t?void 0:t.match(n)})):e.data.Items:[]}))}},{key:"getWebId",value:function(e){var t=this,n=e.target.indexOf("\\")>=0,a=e.target.indexOf("|")>=0;return n||-1!==e.target.indexOf(".")?n?n&&a?t.restGet("/attributes?path=\\\\"+e.target).then((function(t){return void 0===t.data||200!==t.status?[{WebId:e.target,Name:e.display||e.target}]:(t.data.Name=e.display||t.data.Name,[t.data])})):t.restGet("/elements?path=\\\\"+e.target).then((function(t){return void 0===t.data||200!==t.status?[{WebId:e.target,Name:e.display||e.target}]:(t.data.Name=e.display||t.data.Name,[t.data])})):t.piPointSearch(this.piserver.webid,e.target).then((function(t){return void 0===t||0===t.length?[{WebId:e.target,Name:e.display||e.target}]:t})):Promise.resolve([{WebId:e.target,Name:e.display||e.target}])}}])&&re(n.prototype,a),r&&re(n,r),Object.defineProperty(n,"prototype",{writable:!1}),l}(e.DataSourceApi),pe=new e.DataSourcePlugin(me).setConfigEditor(C).setQueryEditor(Y).setAnnotationQueryCtrl(a)})(),s})()));
//# sourceMappingURL=module.js.map