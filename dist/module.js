/*! For license information please see module.js.LICENSE.txt */
define(["@grafana/data","@grafana/runtime","@grafana/ui","lodash","react"],((e,t,n,r,a)=>(()=>{"use strict";var i=[e=>{e.exports=a},e=>{e.exports=n},e=>{e.exports=r},,t=>{t.exports=e},e=>{e.exports=t}],o={};function l(e){var t=o[e];if(void 0!==t)return t.exports;var n=o[e]={exports:{}};return i[e](n,n.exports,l),n.exports}l.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return l.d(t,{a:t}),t},l.d=(e,t)=>{for(var n in t)l.o(t,n)&&!l.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},l.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),l.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var u={};return(()=>{l.r(u),l.d(u,{plugin:()=>se});var e,t=l(4),n=l(0),r=l.n(n),a=l(1);function i(e){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i(e)}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function c(e,t){return c=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},c(e,t)}function f(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=h(e);if(t){var a=h(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return m(this,n)}}function m(e,t){if(t&&("object"===i(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return p(e)}function p(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function h(e){return h=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},h(e)}function v(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function d(){return d=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},d.apply(this,arguments)}var b,g,y=a.LegacyForms.FormField,S=function(e){return d({},e,{jsonData:d({},e.jsonData,{url:e.url})})},E=function(t){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&c(e,t)}(m,t);var n,i,l,u=f(m);function m(){var e;o(this,m);for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return v(p(e=u.call.apply(u,[this].concat(n))),"onPIServerChange",(function(t){var n=e.props,r=n.onOptionsChange,a=n.options,i=d({},a.jsonData,{piserver:t.target.value});r(d({},a,{jsonData:i}))})),v(p(e),"onAFServerChange",(function(t){var n=e.props,r=n.onOptionsChange,a=n.options,i=d({},a.jsonData,{afserver:t.target.value});r(d({},a,{jsonData:i}))})),v(p(e),"onAFDatabaseChange",(function(t){var n=e.props,r=n.onOptionsChange,a=n.options,i=d({},a.jsonData,{afdatabase:t.target.value});r(d({},a,{jsonData:i}))})),v(p(e),"onMyOptionsChange",(function(t){(0,e.props.onOptionsChange)(S(t))})),e}return n=m,(i=[{key:"render",value:function(){var t=this.props.options,n=S(t);return r().createElement("div",null,r().createElement(a.DataSourceHttpSettings,{defaultUrl:"https://server.name/piwebapi",dataSourceConfig:n,onChange:this.onMyOptionsChange,showAccessOptions:!0}),e||(e=r().createElement("h3",{className:"page-heading"},"PI/AF Connection Details")),r().createElement("div",{className:"gf-form-group"},r().createElement("div",{className:"gf-form"},r().createElement(y,{label:"PI Server",labelWidth:10,inputWidth:25,onChange:this.onPIServerChange,value:n.jsonData.piserver||"",placeholder:"Default PI Server to use for data requests"})),r().createElement("div",{className:"gf-form"},r().createElement(y,{label:"AF Server",labelWidth:10,inputWidth:25,onChange:this.onAFServerChange,value:n.jsonData.afserver||"",placeholder:"Default AF Server to use for data requests"})),r().createElement("div",{className:"gf-form"},r().createElement(y,{label:"AF Database",labelWidth:10,inputWidth:25,onChange:this.onAFDatabaseChange,value:n.jsonData.afdatabase||"",placeholder:"Default AF Database server for AF queries"}))))}}])&&s(n.prototype,i),l&&s(n,l),Object.defineProperty(n,"prototype",{writable:!1}),m}(n.PureComponent),w=l(2);function P(){return P=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},P.apply(this,arguments)}var C=function(e){var t=e.label,n=e.labelWidth,i=void 0===n?12:n,o=e.tooltip,l=e.children;return r().createElement(r().Fragment,null,r().createElement(a.InlineFormLabel,{width:i,tooltip:o},t),l)},I=function(){return b||(b=r().createElement("div",{className:"gf-form gf-form--grow"},r().createElement("div",{className:"gf-form-label gf-form-label--grow"})))},x=function(e){var t=P({},e);return r().createElement(O,null,r().createElement(C,t))},O=function(e){return r().createElement("div",{className:"gf-form-inline"},e.children,g||(g=r().createElement(I,null)))},j=function(e){var t=P({},e);return r().createElement(A,null,r().createElement(C,t))},A=function(e){return r().createElement(r().Fragment,null,e.children)},k={target:";",attributes:[],segments:[],regex:{enable:!1},summary:{types:[],basis:"EventWeighted",interval:"",nodata:"Null"},expression:"",interpolate:{enable:!1},recordedValues:{enable:!1},digitalStates:{enable:!1},enableStreaming:{enable:!0},isPiPoint:!1};function F(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==n)return;var r,a,i=[],o=!0,l=!1;try{for(n=n.call(e);!(o=(r=n.next()).done)&&(i.push(r.value),!t||i.length!==t);o=!0);}catch(e){l=!0,a=e}finally{try{o||null==n.return||n.return()}finally{if(l)throw a}}return i}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return D(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return D(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function D(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var W,N,V=function(e){var t=e.isRaw,i=e.onChange,o=F((0,n.useState)(!1),2),l=o[0],u=o[1];return(0,n.useEffect)((function(){u(!1)}),[t]),t?r().createElement(r().Fragment,null,r().createElement(a.Button,{"aria-label":"Switch to visual editor",icon:"pen",variant:"secondary",type:"button",onClick:function(){u(!0)}}),r().createElement(a.ConfirmModal,{isOpen:l,title:"Switch to visual editor mode",body:"Are you sure to switch to visual editor mode? You will lose the changes done in raw query mode.",confirmText:"Yes, switch to editor mode",dismissText:"No, stay in raw query mode",onConfirm:function(){i(!1)},onDismiss:function(){u(!1)}})):r().createElement(a.Button,{"aria-label":"Switch to text editor",icon:"pen",variant:"secondary",type:"button",onClick:function(){i(!0)}})};function T(e){return T="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},T(e)}function B(){return B=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},B.apply(this,arguments)}function R(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function q(e,t){return q=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},q(e,t)}function _(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Q(e);if(t){var a=Q(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return L(this,n)}}function L(e,t){if(t&&("object"===T(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return G(e)}function G(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Q(e){return Q=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},Q(e)}function M(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var H=24,U=250,$="-REMOVE-",Y=function(e){var t;return e.value?r().createElement("div",{className:"gf-form-label ".concat("template"===e.value.type?"query-keyword":"")},null!==(t=e.label)&&void 0!==t?t:"--no label--"):W||(W=r().createElement("a",{className:"gf-form-label query-part"},r().createElement(a.Icon,{name:"plus"})))},J=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&q(e,t)}(l,e);var t,n,i,o=_(l);function l(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,l),M(G(t=o.call(this,e)),"error",void 0),M(G(t),"piServer",[]),M(G(t),"availableAttributes",{}),M(G(t),"summaryTypes",void 0),M(G(t),"calculationBasis",void 0),M(G(t),"noDataReplacement",void 0),M(G(t),"state",{isPiPoint:!1,segments:[],attributes:[],summaries:[],attributeSegment:{},summarySegment:{},calculationBasisSegment:{},noDataReplacementSegment:{}}),M(G(t),"segmentChangeValue",(function(e){var n=t.props.query;t.setState({segments:e},(function(){return t.onChange(B({},n,{segments:e}))}))})),M(G(t),"attributeChangeValue",(function(e){var n=t.props.query;t.setState({attributes:e},(function(){return t.onChange(B({},n,{attributes:e}))}))})),M(G(t),"onPiPointChange",(function(e,n){var r=t.state.attributes.slice(0);e.label===$?(0,w.remove)(r,(function(e,t){return t===n})):r[n]=e,t.checkPiPointSegments(e,r)})),M(G(t),"onAttributeChange",(function(e,n){var r=t.state.attributes.slice(0);r[n]=e,t.checkAttributeSegments(r,t.state.segments,!1)})),M(G(t),"onSegmentChange",(function(e,n){var r,a,i=t.props.query,o=t.state.segments.slice(0);return e.label===$?(o=(0,w.slice)(o,0,n),t.checkAttributeSegments([],o,!1),0===o.length?o.push({label:""}):null!==(a=o[o.length-1].value)&&void 0!==a&&a.expandable&&o.push({label:"Select Element",value:{value:"-Select Element-"}}),i.isPiPoint&&(t.piServer=[]),void t.segmentChangeValue(o)):(o[n]=e,i.isPiPoint?(t.piServer.push(e),void t.segmentChangeValue(o)):(n<o.length-1&&(o=(0,w.slice)(o,0,n+1)),t.checkAttributeSegments([],o,!1),null!==(r=e.value)&&void 0!==r&&r.expandable&&o.push({label:"Select Element",value:{value:"-Select Element-"}}),void t.segmentChangeValue(o)))})),M(G(t),"getElementSegments",(function(e,n){var r,a,i=t.props,o=i.datasource,l=i.query,u=i.data,s=G(t),c=l.isPiPoint?{type:"dataserver"}:{path:t.getSegmentPathUpTo(null!=n?n:t.state.segments.slice(0),e)};if(!l.isPiPoint){var f,m,p;if(null!==(f=o.afserver)&&void 0!==f&&f.name&&0===e)return Promise.resolve([{label:o.afserver.name,value:{value:o.afserver.name,expandable:!0}}]);if(null!==(m=o.afserver)&&void 0!==m&&m.name&&null!==(p=o.afdatabase)&&void 0!==p&&p.name&&1===e)return Promise.resolve([{label:o.afdatabase.name,value:{value:o.afdatabase.name,expandable:!0}}])}return o.metricFindQuery(c,Object.assign(null!==(r=null==u||null===(a=u.request)||void 0===a?void 0:a.scopedVars)&&void 0!==r?r:{},{isPiPoint:l.isPiPoint})).then((function(e){var t=(0,w.map)(e,(function(e){return{label:e.text,value:{webId:e.WebId,value:e.text,expandable:!l.isPiPoint&&e.expandable}}}));if(0===t.length)return t;var n=o.templateSrv.getVariables();return(0,w.each)(n,(function(e){var n={label:"${"+e.name+"}",value:{type:"template",value:"${"+e.name+"}",expandable:!l.isPiPoint}};t.unshift(n)})),t.unshift({label:$,value:{value:$}}),t})).catch((function(e){return s.error=e.message||"Failed to issue metric query",[]}))})),M(G(t),"getAttributeSegmentsPI",(function(e){var n,r,a=t.props,i=a.datasource,o=a.query,l=a.data,u=G(t),s={path:"",webId:t.getSelectedPIServer(),pointName:(null!=e?e:"")+"*",type:"pipoint"},c=[];return i.metricFindQuery(s,Object.assign(null!==(n=null==l||null===(r=l.request)||void 0===r?void 0:r.scopedVars)&&void 0!==n?n:{},{isPiPoint:o.isPiPoint})).then((function(t){return(c=(0,w.map)(t,(function(e){return{path:e.Path,label:e.text,value:{value:e.text,expandable:!1}}}))).unshift({label:e,value:{value:e,expandable:!1}}),c.unshift({label:$,value:{value:$}}),c})).catch((function(e){return u.error=e.message||"Failed to issue metric query",c}))})),M(G(t),"getAttributeSegmentsAF",(function(e){var n=G(t),r=[];return(0,w.forOwn)(n.availableAttributes,(function(e,t){var n={label:t,value:{value:t,expandable:!0}};r.push(n)})),r.unshift({label:$,value:{value:$}}),r})),M(G(t),"buildFromTarget",(function(e,n,r){var a=e.target.split(";"),i=a.length>0?a[0].split("\\"):[];return i.length>1||1===i.length&&""!==i[0]?(a.splice(0,1),(0,w.each)(i,(function(e,t){n.push({label:e,value:{value:e,expandable:!0}})})),(0,w.each)(a,(function(e,t){""!==e&&r.push({label:e,value:{value:e,expandable:!1}})})),t.getElementSegments(i.length+1,n).then((function(e){return e.length>0&&n.push({label:"Select Element",value:{value:"-Select Element-"}}),n}))):Promise.resolve(n)})),M(G(t),"checkAfServer",(function(){var e,n,r=t.props.datasource,a=[];null!==(e=r.afserver)&&void 0!==e&&e.name?(a.push({label:r.afserver.name,value:{value:r.afserver.name,expandable:!0}}),null!==(n=r.afdatabase)&&void 0!==n&&n.name&&a.push({label:r.afdatabase.name,value:{value:r.afdatabase.name,expandable:!0}}),a.push({label:"Select Element",value:{value:"-Select Element-"}})):a.push({label:""});return a})),M(G(t),"updateArray",(function(e,n,r,a,i){t.setState({segments:e,attributes:n,summaries:r,isPiPoint:a},(function(){return t.checkAttributeSegments(n,t.state.segments,a).then((function(){i&&i()}))}))})),M(G(t),"scopedVarsDone",!1),M(G(t),"componentDidMount",(function(){t.initialLoad(!1)})),M(G(t),"componentDidUpdate",(function(){var e,n,r,a=t.props.query;"Done"===(null===(e=t.props.data)||void 0===e?void 0:e.state)&&null!==(n=t.props.data)&&void 0!==n&&null!==(r=n.request)&&void 0!==r&&r.scopedVars&&!t.scopedVarsDone&&(t.scopedVarsDone=!0,t.initialLoad(!a.isPiPoint))})),M(G(t),"initialLoad",(function(e){var n,r,a,i=t.props.query,o=(0,w.defaults)(i,k),l=o.segments,u=o.attributes,s=o.summary,c=o.isPiPoint,f=e?[]:null!==(n=null==l?void 0:l.slice(0))&&void 0!==n?n:[],m=e?[]:null!==(r=null==u?void 0:u.slice(0))&&void 0!==r?r:[],p=null!==(a=null==s?void 0:s.types)&&void 0!==a?a:[];if(c||0!==f.length)c&&f.length>0&&(t.piServer=f);else{if(i.target&&i.target.length>0&&";"!==i.target)return m=[],void t.buildFromTarget(i,f,m).then((function(e){t.updateArray(e,m,p,c)})).catch((function(e){}));f=t.checkAfServer()}t.updateArray(f,m,p,c,(function(){t.onChange(i)}))})),M(G(t),"onChange",(function(e){var n,r=t.props,a=r.onChange,i=r.onRunQuery;if(e.summary.types=t.state.summaries,e.rawQuery){if(e.target=null!==(n=e.query)&&void 0!==n?n:"",""!==e.target){var o=e.target.split(";"),l=o[0].split("\\");o.splice(0,1),e.attributes=[],(l.length>1||1===l.length&&""!==l[0])&&(e.elementPath=l.join("\\"),(0,w.each)(o,(function(t,n){""!==t&&e.attributes.push({label:t,value:{value:t,expandable:!1}})})))}}else e.elementPath=t.getSegmentPathUpTo(t.state.segments,t.state.segments.length),e.target=e.elementPath+";"+(0,w.join)(e.attributes.map((function(e){var t;return null===(t=e.value)||void 0===t?void 0:t.value})),";");a(e),e.target&&e.target.length>0&&e.attributes.length>0&&i()})),M(G(t),"stateCallback",(function(){var e=t.props.query;t.onChange(e)})),M(G(t),"onIsPiPointChange",(function(e){var n=t.props.query,r=!n.isPiPoint;t.setState({segments:r?[{label:""}]:t.checkAfServer(),attributes:[],isPiPoint:r},(function(){t.onChange(B({},n,{expression:"",attributes:t.state.attributes,segments:t.state.segments,isPiPoint:r}))}))})),t.onSegmentChange=t.onSegmentChange.bind(G(t)),t.calcBasisValueChanged=t.calcBasisValueChanged.bind(G(t)),t.calcNoDataValueChanged=t.calcNoDataValueChanged.bind(G(t)),t.onSummaryAction=t.onSummaryAction.bind(G(t)),t.onSummaryValueChanged=t.onSummaryValueChanged.bind(G(t)),t.onAttributeAction=t.onAttributeAction.bind(G(t)),t.onAttributeChange=t.onAttributeChange.bind(G(t)),t.summaryTypes=["Total","Average","Minimum","Maximum","Range","StdDev","PopulationStdDev","Count","PercentGood","All","AllForNonNumeric"],t.calculationBasis=["TimeWeighted","EventWeighted","TimeWeightedContinuous","TimeWeightedDiscrete","EventWeightedExcludeMostRecentEvent","EventWeightedExcludeEarliestEvent","EventWeightedIncludeBothEnds"],t.noDataReplacement=["Null","Drop","Previous","0","Keep"],t}return t=l,(n=[{key:"isValueEmpty",value:function(e){return!e||!e.value||!e.value.length||e.value===$}},{key:"calcBasisValueChanged",value:function(e){var t,n=this.props.query,r=n.summary;r.basis=null===(t=e.value)||void 0===t?void 0:t.value,this.onChange(B({},n,{summary:r}))}},{key:"getCalcBasisSegments",value:function(){return(0,w.map)(this.calculationBasis,(function(e){return{label:e,value:{value:e,expandable:!0}}}))}},{key:"calcNoDataValueChanged",value:function(e){var t,n=this.props.query,r=n.summary;r.nodata=null===(t=e.value)||void 0===t?void 0:t.value,this.onChange(B({},n,{summary:r}))}},{key:"getNoDataSegments",value:function(){return(0,w.map)(this.noDataReplacement,(function(e){return{label:e,value:{value:e,expandable:!0}}}))}},{key:"onSummaryValueChanged",value:function(e,t){var n=this.state.summaries.slice(0);n[t]=e,this.isValueEmpty(e.value)&&n.splice(t,1),this.setState({summaries:n},this.stateCallback)}},{key:"getSummarySegments",value:function(){var e=this,t=(0,w.filter)(this.summaryTypes,(function(t){return-1===e.state.summaries.map((function(e){var t;return null===(t=e.value)||void 0===t?void 0:t.value})).indexOf(t)})),n=(0,w.map)(t,(function(e){return{label:e,value:{value:e,expandable:!0}}}));return n.unshift({label:$,value:{value:$}}),n}},{key:"removeSummary",value:function(e){var t=(0,w.filter)(this.state.summaries,(function(t){return t!==e}));this.setState({summaries:t})}},{key:"onSummaryAction",value:function(e){var t=this.state.summaries.slice(0);if(!this.isValueEmpty(e.value)){var n,r={label:e.label,value:{value:null===(n=e.value)||void 0===n?void 0:n.value,expandable:!0}};t.push(r)}this.setState({summarySegment:{},summaries:t},this.stateCallback)}},{key:"removeAttribute",value:function(e){var t=(0,w.filter)(this.state.attributes,(function(t){return t!==e}));this.attributeChangeValue(t)}},{key:"onAttributeAction",value:function(e){var t=this.props.query,n=this.state.attributes.slice(0);if(!this.isValueEmpty(e.value)){var r,a={label:e.label,value:{value:null===(r=e.value)||void 0===r?void 0:r.value,expandable:!t.isPiPoint}};n.push(a)}this.attributeChangeValue(n)}},{key:"getSegmentPathUpTo",value:function(e,t){var n=e.slice(0,t);return(0,w.reduce)(n,(function(e,t){var n;return t.value?null!==(n=t.value.value)&&void 0!==n&&n.startsWith("-Select")?e:e?e+"\\"+t.value.value:t.value.value:""}),"")}},{key:"checkAttributeSegments",value:function(e,t,n){var r,a,i,o,l,u=this,s=this.props,c=s.datasource,f=s.data,m=this,p={path:this.getSegmentPathUpTo(t.slice(0),t.length),type:"attributes",webId:"",pointName:""};n&&(p.type="pipoint",null!==(i=t[0].value)&&void 0!==i&&i.webId&&(p.webId=null===(l=t[0].value)||void 0===l?void 0:l.webId),null!==(o=e[0].value)&&void 0!==o&&o.value&&(p.pointName=e[0].value.value));return c.metricFindQuery(p,Object.assign(null!==(r=null==f||null===(a=f.request)||void 0===a?void 0:a.scopedVars)&&void 0!==r?r:{},{isPiPoint:n})).then((function(e){var t={};(0,w.each)(e,(function(e){t[e.Path.substring(e.Path.indexOf("|")+1)]=e.WebId}));var n=(0,w.filter)(t,(function(e){var n,r=c.templateSrv.replace(null===(n=e.value)||void 0===n?void 0:n.value);return void 0!==t[r]}));m.availableAttributes=t,n.length>0&&u.attributeChangeValue(n)})).catch((function(t){m.error=t.message||"Failed to issue metric query",u.attributeChangeValue(e)}))}},{key:"checkPiPointSegments",value:function(e,t){var n,r,a=this.props,i=a.datasource,o=a.data,l=this,u={path:e.path,webId:l.getSelectedPIServer(),pointName:e.label,type:"pipoint"};return i.metricFindQuery(u,Object.assign(null!==(n=null==o||null===(r=o.request)||void 0===r?void 0:r.scopedVars)&&void 0!==n?n:{},{isPiPoint:!0})).then((function(){l.attributeChangeValue(t)})).catch((function(e){l.error=e.message||"Failed to issue metric query",l.attributeChangeValue([])}))}},{key:"getSelectedPIServer",value:function(){var e,t=this,n="";return this.piServer.forEach((function(e){var r=t.props.query.target.split(";");r.length>=2&&r[0]===e.text&&(n=e.WebId)})),this.piServer.length>0?null===(e=this.piServer[0].value)||void 0===e?void 0:e.webId:n}},{key:"textEditorChanged",value:function(){var e=this,t=this.props,n=t.query,r=t.onChange,a=n.target.split(";"),i=a.length>0?a[0].split("\\"):[],o=[],l=[];i.length>1||1===i.length&&""!==i[0]?(a.splice(0,1),(0,w.each)(i,(function(e,t){o.push({label:e,value:{type:e.match(/\${\w+}/gi)?"template":void 0,value:e,expandable:!0}})})),this.getElementSegments(i.length+1,o).then((function(e){e.length>0&&o.push({label:"Select Element",value:{value:"-Select Element-"}})})),(0,w.each)(a,(function(e,t){""!==e&&l.push({label:e,value:{value:e,expandable:!1}})})),this.updateArray(o,l,this.state.summaries,n.isPiPoint,(function(){r(B({},n,{query:void 0,rawQuery:!1}))}))):(o=this.checkAfServer(),this.updateArray(o,this.state.attributes,this.state.summaries,n.isPiPoint,(function(){e.onChange(B({},n,{query:void 0,rawQuery:!1,attributes:e.state.attributes,segments:e.state.segments}))})))}},{key:"render",value:function(){var e=this,t=this.props,n=t.query,i=t.onChange,o=t.onRunQuery,l=(0,w.defaults)(n,k),u=l.interpolate,s=l.query,c=l.rawQuery,f=l.enableStreaming,m=l.recordedValues,p=l.expression,h=l.isPiPoint,v=l.summary,d=l.display,b=l.regex;return r().createElement(r().Fragment,null,r().createElement(a.InlineField,{label:"Is Pi Point?",labelWidth:H},r().createElement(a.InlineSwitch,{value:h,onChange:this.onIsPiPointChange})),!!c&&r().createElement(a.InlineFieldRow,null,r().createElement(a.InlineField,{label:"Raw Query",labelWidth:H,grow:!0},r().createElement(a.Input,{onBlur:this.stateCallback,value:s,onChange:function(e){return i(B({},l,{query:e.target.value}))},placeholder:"enter query"})),r().createElement(V,{isRaw:!0,onChange:function(t){return e.textEditorChanged()}})),!c&&r().createElement(r().Fragment,null,r().createElement("div",{className:"gf-form-inline"},r().createElement(j,{label:h?"PI Server":"AF Elements",tooltip:h?"Select PI server.":"Select AF Element."},this.state.segments.map((function(t,n){return r().createElement(a.SegmentAsync,{key:"element-"+n,Component:r().createElement(Y,{value:t.value,label:t.label}),onChange:function(t){return e.onSegmentChange(t,n)},loadOptions:function(t){return e.getElementSegments(n)},allowCustomValue:!0,inputMinWidth:200})})),N||(N=r().createElement(I,null)),!h&&r().createElement(V,{isRaw:!1,onChange:function(e){i(B({},l,{query:l.target,rawQuery:e}))}}))),r().createElement(x,{label:h?"Pi Points":"Attributes"},this.state.attributes.map((function(t,n){return h?r().createElement(a.SegmentAsync,{key:"attributes-"+n,Component:r().createElement(Y,{value:t.value,label:t.label}),disabled:0===e.piServer.length,onChange:function(t){return e.onPiPointChange(t,n)},loadOptions:e.getAttributeSegmentsPI,reloadOptionsOnChange:!0,allowCustomValue:!0,inputMinWidth:U}):r().createElement(a.Segment,{key:"attributes-"+n,Component:r().createElement(Y,{value:t.value,label:t.label}),disabled:e.state.segments.length<=2,onChange:function(t){return e.onAttributeChange(t,n)},options:e.getAttributeSegmentsAF(),allowCustomValue:!0,inputMinWidth:U})})),h&&r().createElement(a.SegmentAsync,{Component:r().createElement(Y,{value:this.state.attributeSegment.value,label:this.state.attributeSegment.label}),disabled:0===this.piServer.length,onChange:this.onAttributeAction,loadOptions:this.getAttributeSegmentsPI,reloadOptionsOnChange:!0,allowCustomValue:!0,inputMinWidth:U}),!h&&r().createElement(a.Segment,{Component:r().createElement(Y,{value:this.state.attributeSegment.value,label:this.state.attributeSegment.label}),disabled:this.state.segments.length<=2,onChange:this.onAttributeAction,options:this.getAttributeSegmentsAF(),allowCustomValue:!0,inputMinWidth:U}))),!h&&r().createElement(a.InlineField,{label:"Calculation",labelWidth:H,tooltip:"Modify all attributes by an equation. Use '.' for current item. Leave Attributes empty if you wish to perform element based calculations."},r().createElement(a.Input,{onBlur:o,value:p,onChange:function(t){return e.onChange(B({},l,{expression:t.target.value}))},placeholder:"'.'*2"})),r().createElement(a.InlineFieldRow,null,r().createElement(a.InlineField,{label:"Max Recorded Values",labelWidth:H,tooltip:"Maximum number of recorded value to retrive from the data archive, without using interpolation."},r().createElement(a.Input,{onBlur:o,value:m.maxNumber,onChange:function(t){return e.onChange(B({},l,{recordedValues:B({},m,{maxNumber:parseInt(t.target.value,10)})}))},type:"number",placeholder:"1000"})),r().createElement(a.InlineField,{label:"Recorded Values",labelWidth:H},r().createElement(a.InlineSwitch,{value:m.enable,onChange:function(){return e.onChange(B({},l,{recordedValues:B({},m,{enable:!m.enable})}))}})),r().createElement(a.InlineField,{label:"Enable Streaming",labelWidth:H},r().createElement(a.InlineSwitch,{value:f.enable,onChange:function(){return e.onChange(B({},l,{enableStreaming:B({},f,{enable:!f.enable})}))}}))),r().createElement(a.InlineFieldRow,null,r().createElement(a.InlineField,{label:"Interpolate Period",labelWidth:H,tooltip:"Override time between sampling, e.g. '30s'. Defaults to timespan/chart width."},r().createElement(a.Input,{onBlur:o,value:u.interval,onChange:function(t){return e.onChange(B({},l,{interpolate:B({},u,{interval:t.target.value})}))},placeholder:"30s"})),r().createElement(a.InlineField,{label:"Interpolate",labelWidth:H},r().createElement(a.InlineSwitch,{value:u.enable,onChange:function(){return e.onChange(B({},l,{interpolate:B({},u,{enable:!u.enable})}))}})),r().createElement(a.InlineField,{label:"Replace Bad Data",labelWidth:H,tooltip:"Replacement for bad quality values."},r().createElement(a.Segment,{Component:r().createElement(Y,{value:{value:v.nodata},label:v.nodata}),onChange:this.calcNoDataValueChanged,options:this.getNoDataSegments(),allowCustomValue:!0}))),r().createElement(a.InlineFieldRow,null,r().createElement(a.InlineField,{label:"Summary Period",labelWidth:H,tooltip:"Override time between sampling, e.g. '30s'."},r().createElement(a.Input,{onBlur:o,value:v.interval,onChange:function(e){return i(B({},l,{summary:B({},v,{interval:e.target.value})}))},placeholder:"30s"})),r().createElement(a.InlineField,{label:"Basis",labelWidth:H,tooltip:"Defines the possible calculation options when performing summary calculations over time-series data."},r().createElement(a.Segment,{Component:r().createElement(Y,{value:{value:v.basis},label:v.basis}),onChange:this.calcBasisValueChanged,options:this.getCalcBasisSegments(),allowCustomValue:!0})),r().createElement(a.InlineField,{label:"Summaries",labelWidth:H,tooltip:"Replacement for bad quality values."},r().createElement(a.InlineFieldRow,null,this.state.summaries.map((function(t,n){return r().createElement(a.Segment,{key:"summaries-"+n,Component:r().createElement(Y,{value:t.value,label:t.label}),onChange:function(t){return e.onSummaryValueChanged(t,n)},options:e.getSummarySegments(),allowCustomValue:!0})})),r().createElement(a.Segment,{Component:r().createElement(Y,{value:this.state.summarySegment.value,label:this.state.summarySegment.label}),onChange:this.onSummaryAction,options:this.getSummarySegments(),allowCustomValue:!0})))),r().createElement(a.InlineFieldRow,null,r().createElement(a.InlineField,{label:"Display Name",labelWidth:H,tooltip:"If single attribute, modify display name. Otherwise use regex to modify display name."},r().createElement(a.Input,{onBlur:o,value:d,onChange:function(t){return e.onChange(B({},l,{display:t.target.value}))},placeholder:"Display"})),r().createElement(a.InlineField,{label:"Enable Regex Replace",labelWidth:H},r().createElement(a.InlineSwitch,{value:b.enable,onChange:function(){e.onChange(B({},l,{regex:B({},b,{enable:!b.enable})}))}})),r().createElement(a.InlineField,{label:"Search",labelWidth:16},r().createElement(a.Input,{onBlur:o,value:b.search,onChange:function(t){return e.onChange(B({},l,{regex:B({},b,{search:t.target.value})}))},placeholder:"(.*)"})),r().createElement(a.InlineField,{label:"Replace",labelWidth:16},r().createElement(a.Input,{onBlur:o,value:b.replace,onChange:function(t){return e.onChange(B({},l,{regex:B({},b,{replace:t.target.value})}))},placeholder:"$1"}))))}}])&&R(t.prototype,n),i&&R(t,i),Object.defineProperty(t,"prototype",{writable:!1}),l}(n.PureComponent),K=l(5);function z(e){return z="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},z(e)}function X(){return X=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},X.apply(this,arguments)}function Z(){Z=function(){return e};var e={},t=Object.prototype,n=t.hasOwnProperty,r="function"==typeof Symbol?Symbol:{},a=r.iterator||"@@iterator",i=r.asyncIterator||"@@asyncIterator",o=r.toStringTag||"@@toStringTag";function l(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,n){return e[t]=n}}function u(e,t,n,r){var a=t&&t.prototype instanceof f?t:f,i=Object.create(a.prototype),o=new P(r||[]);return i._invoke=function(e,t,n){var r="suspendedStart";return function(a,i){if("executing"===r)throw new Error("Generator is already running");if("completed"===r){if("throw"===a)throw i;return I()}for(n.method=a,n.arg=i;;){var o=n.delegate;if(o){var l=S(o,n);if(l){if(l===c)continue;return l}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if("suspendedStart"===r)throw r="completed",n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);r="executing";var u=s(e,t,n);if("normal"===u.type){if(r=n.done?"completed":"suspendedYield",u.arg===c)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(r="completed",n.method="throw",n.arg=u.arg)}}}(e,n,o),i}function s(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}e.wrap=u;var c={};function f(){}function m(){}function p(){}var h={};l(h,a,(function(){return this}));var v=Object.getPrototypeOf,d=v&&v(v(C([])));d&&d!==t&&n.call(d,a)&&(h=d);var b=p.prototype=f.prototype=Object.create(h);function g(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function y(e,t){function r(a,i,o,l){var u=s(e[a],e,i);if("throw"!==u.type){var c=u.arg,f=c.value;return f&&"object"==z(f)&&n.call(f,"__await")?t.resolve(f.__await).then((function(e){r("next",e,o,l)}),(function(e){r("throw",e,o,l)})):t.resolve(f).then((function(e){c.value=e,o(c)}),(function(e){return r("throw",e,o,l)}))}l(u.arg)}var a;this._invoke=function(e,n){function i(){return new t((function(t,a){r(e,n,t,a)}))}return a=a?a.then(i,i):i()}}function S(e,t){var n=e.iterator[t.method];if(void 0===n){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,S(e,t),"throw"===t.method))return c;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return c}var r=s(n,e.iterator,t.arg);if("throw"===r.type)return t.method="throw",t.arg=r.arg,t.delegate=null,c;var a=r.arg;return a?a.done?(t[e.resultName]=a.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,c):a:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,c)}function E(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function w(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function P(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(E,this),this.reset(!0)}function C(e){if(e){var t=e[a];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var r=-1,i=function t(){for(;++r<e.length;)if(n.call(e,r))return t.value=e[r],t.done=!1,t;return t.value=void 0,t.done=!0,t};return i.next=i}}return{next:I}}function I(){return{value:void 0,done:!0}}return m.prototype=p,l(b,"constructor",p),l(p,"constructor",m),m.displayName=l(p,o,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===m||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,p):(e.__proto__=p,l(e,o,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},g(y.prototype),l(y.prototype,i,(function(){return this})),e.AsyncIterator=y,e.async=function(t,n,r,a,i){void 0===i&&(i=Promise);var o=new y(u(t,n,r,a),i);return e.isGeneratorFunction(n)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},g(b),l(b,o,"Generator"),l(b,a,(function(){return this})),l(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var n in e)t.push(n);return t.reverse(),function n(){for(;t.length;){var r=t.pop();if(r in e)return n.value=r,n.done=!1,n}return n.done=!0,n}},e.values=C,P.prototype={constructor:P,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(w),!e)for(var t in this)"t"===t.charAt(0)&&n.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function r(n,r){return o.type="throw",o.arg=e,t.next=n,r&&(t.method="next",t.arg=void 0),!!r}for(var a=this.tryEntries.length-1;a>=0;--a){var i=this.tryEntries[a],o=i.completion;if("root"===i.tryLoc)return r("end");if(i.tryLoc<=this.prev){var l=n.call(i,"catchLoc"),u=n.call(i,"finallyLoc");if(l&&u){if(this.prev<i.catchLoc)return r(i.catchLoc,!0);if(this.prev<i.finallyLoc)return r(i.finallyLoc)}else if(l){if(this.prev<i.catchLoc)return r(i.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return r(i.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var a=this.tryEntries[r];if(a.tryLoc<=this.prev&&n.call(a,"finallyLoc")&&this.prev<a.finallyLoc){var i=a;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var o=i?i.completion:{};return o.type=e,o.arg=t,i?(this.method="next",this.next=i.finallyLoc,c):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),c},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),w(n),c}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var a=r.arg;w(n)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,n){return this.delegate={iterator:C(e),resultName:t,nextLoc:n},"next"===this.method&&(this.arg=void 0),c}},e}function ee(e,t,n,r,a,i,o){try{var l=e[i](o),u=l.value}catch(e){return void n(e)}l.done?t(u):Promise.resolve(u).then(r,a)}function te(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function ne(e,t){return ne=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},ne(e,t)}function re(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=oe(e);if(t){var a=oe(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return ae(this,n)}}function ae(e,t){if(t&&("object"===z(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return ie(e)}function ie(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function oe(e){return oe=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},oe(e)}function le(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var ue=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&ne(e,t)}(l,e);var t,n,r,a,i,o=re(l);function l(e){var t;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,l),le(ie(t=o.call(this,e)),"piserver",void 0),le(ie(t),"afserver",void 0),le(ie(t),"afdatabase",void 0),le(ie(t),"templateSrv",void 0),t.templateSrv=(0,K.getTemplateSrv)(),t.piserver={name:(e.jsonData||{}).piserver,webid:void 0},t.afserver={name:(e.jsonData||{}).afserver,webid:void 0},t.afdatabase={name:(e.jsonData||{}).afdatabase,webid:void 0},t.annotations={},t}return t=l,n=[{key:"metricFindQuery",value:(a=Z().mark((function e(t,n){var r,a,i,o;return Z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=this,i=["servers","databases","databaseElements","elements"],"string"==typeof t&&(t=JSON.parse(t)),n.isPiPoint?t.path=this.templateSrv.replace(t.path,n):(""===t.path?t.type=i[0]:"attributes"!==t.type&&(t.type=i[Math.max(0,Math.min(t.path.split("\\").length,i.length-1))]),t.path=this.templateSrv.replace(t.path,n),t.path=t.path.replace(/\{([^\\])*\}/gi,(function(e){return e.substring(1,e.length-2).split(",")[0]}))),t.filter=null!==(r=t.filter)&&void 0!==r?r:"*","servers"!==t.type){e.next=9;break}return e.abrupt("return",null!==(o=a.afserver)&&void 0!==o&&o.name?a.getAssetServer(a.afserver.name).then((function(e){return[e]})).then(a.metricQueryTransform):a.getAssetServers().then(a.metricQueryTransform));case 9:if("databases"!==t.type){e.next=13;break}return e.abrupt("return",a.getAssetServer(t.path).then((function(e){var t;return a.getDatabases(null!==(t=e.WebId)&&void 0!==t?t:"",{})})).then(a.metricQueryTransform));case 13:if("databaseElements"!==t.type){e.next=17;break}return e.abrupt("return",a.getDatabase(t.path).then((function(e){var t;return a.getDatabaseElements(null!==(t=e.WebId)&&void 0!==t?t:"",{selectedFields:"Items.WebId%3BItems.Name%3BItems.Items%3BItems.Path%3BItems.HasChildren"})})).then(a.metricQueryTransform));case 17:if("elements"!==t.type){e.next=21;break}return e.abrupt("return",a.getElement(t.path).then((function(e){var n;return a.getElements(null!==(n=e.WebId)&&void 0!==n?n:"",{selectedFields:"Items.WebId%3BItems.Name%3BItems.Items%3BItems.Path%3BItems.HasChildren",nameFilter:t.filter})})).then(a.metricQueryTransform));case 21:if("attributes"!==t.type){e.next=25;break}return e.abrupt("return",a.getElement(t.path).then((function(e){var n;return a.getAttributes(null!==(n=e.WebId)&&void 0!==n?n:"",{searchFullHierarchy:"true",selectedFields:"Items.WebId%3BItems.Name%3BItems.Path",nameFilter:t.filter})})).then(a.metricQueryTransform));case 25:if("dataserver"!==t.type){e.next=29;break}return e.abrupt("return",a.getDataServers().then(a.metricQueryTransform));case 29:if("pipoint"!==t.type){e.next=31;break}return e.abrupt("return",a.piPointSearch(t.webId,t.pointName).then(a.metricQueryTransform));case 31:return e.abrupt("return",Promise.reject("Bad type"));case 32:case"end":return e.stop()}}),e,this)})),i=function(){var e=this,t=arguments;return new Promise((function(n,r){var i=a.apply(e,t);function o(e){ee(i,n,r,o,l,"next",e)}function l(e){ee(i,n,r,o,l,"throw",e)}o(void 0)}))},function(e,t){return i.apply(this,arguments)})},{key:"applyTemplateVariables",value:function(e){return e&&e.query?X({},e,{query:(0,K.getTemplateSrv)().replace(e.query)}):e}},{key:"metricQueryTransform",value:function(e){return w.map(e,(function(e){var t,n;return{text:e.Name,expandable:void 0===e.HasChildren||!0===e.HasChildren||(null!==(t=e.Path)&&void 0!==t?t:"").split("\\").length<=3,HasChildren:e.HasChildren,Items:null!==(n=e.Items)&&void 0!==n?n:[],Path:e.Path,WebId:e.WebId}}))}},{key:"restGet",value:function(e){return(0,K.getBackendSrv)().datasourceRequest({url:"/api/datasources/".concat(this.id,"/resources/").concat(e),method:"GET",headers:{"Content-Type":"application/json"}}).then((function(e){return e}))}},{key:"getDataServers",value:function(){return this.restGet("/dataservers").then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}},{key:"getAssetServers",value:function(){return this.restGet("/assetservers").then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}},{key:"getAssetServer",value:function(e){return e?this.restGet("/assetservers?path=\\\\"+e).then((function(e){return e.data})):Promise.resolve({})}},{key:"getDatabase",value:function(e){return e?this.restGet("/assetdatabases?path=\\\\"+e).then((function(e){return e.data})):Promise.resolve({})}},{key:"getDatabases",value:function(e,t){return e?this.restGet("/assetservers/"+e+"/assetdatabases").then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]})):Promise.resolve([])}},{key:"getElement",value:function(e){return e?this.restGet("/elements?path=\\\\"+e).then((function(e){return e.data})):Promise.resolve({})}},{key:"getEventFrameTemplates",value:function(e){return e?this.restGet("/assetdatabases/"+e+"/elementtemplates?selectedFields=Items.InstanceType%3BItems.Name%3BItems.WebId").then((function(e){var t;return w.filter(null!==(t=e.data.Items)&&void 0!==t?t:[],(function(e){return"EventFrame"===e.InstanceType}))})):Promise.resolve([])}},{key:"getElementTemplates",value:function(e){return e?this.restGet("/assetdatabases/"+e+"/elementtemplates?selectedFields=Items.InstanceType%3BItems.Name%3BItems.WebId").then((function(e){var t;return w.filter(null!==(t=e.data.Items)&&void 0!==t?t:[],(function(e){return"Element"===e.InstanceType}))})):Promise.resolve([])}},{key:"getAttributes",value:function(e,t){var n="?"+w.map(t,(function(e,t){return t+"="+e})).join("&");return"?"===n&&(n=""),this.restGet("/elements/"+e+"/attributes"+n).then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}},{key:"getDatabaseElements",value:function(e,t){var n="?"+w.map(t,(function(e,t){return t+"="+e})).join("&");return"?"===n&&(n=""),this.restGet("/assetdatabases/"+e+"/elements"+n).then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}},{key:"getElements",value:function(e,t){var n="?"+w.map(t,(function(e,t){return t+"="+e})).join("&");return"?"===n&&(n=""),this.restGet("/elements/"+e+"/elements"+n).then((function(e){var t;return null!==(t=e.data.Items)&&void 0!==t?t:[]}))}},{key:"piPointSearch",value:function(e,t){var n=this.templateSrv.replace(t),r="".concat(n),a=!1;if(n!==t)for(var i,o=/\{(\w|,)+\}/g;null!==(i=o.exec(n));)i.index===o.lastIndex&&o.lastIndex++,i.forEach((function(e,t){0===t&&(n=n.replace(e,e.replace("{","(").replace("}",")").replace(",","|")),r=r.replace(e,"*"),a=!0)}));return this.restGet("/dataservers/"+e+"/points?maxCount=20&nameFilter="+r).then((function(e){var t;return e&&null!==(t=e.data)&&void 0!==t&&t.Items?a?e.data.Items.filter((function(e){var t;return null===(t=e.Name)||void 0===t?void 0:t.match(n)})):e.data.Items:[]}))}},{key:"getWebId",value:function(e){var t=this,n=e.target.indexOf("\\")>=0,r=e.target.indexOf("|")>=0;return n||-1!==e.target.indexOf(".")?n?n&&r?t.restGet("/attributes?path=\\\\"+e.target).then((function(t){return void 0===t.data||200!==t.status?[{WebId:e.target,Name:e.display||e.target}]:(t.data.Name=e.display||t.data.Name,[t.data])})):t.restGet("/elements?path=\\\\"+e.target).then((function(t){return void 0===t.data||200!==t.status?[{WebId:e.target,Name:e.display||e.target}]:(t.data.Name=e.display||t.data.Name,[t.data])})):t.piPointSearch(this.piserver.webid,e.target).then((function(t){return void 0===t||0===t.length?[{WebId:e.target,Name:e.display||e.target}]:t})):Promise.resolve([{WebId:e.target,Name:e.display||e.target}])}}],n&&te(t.prototype,n),r&&te(t,r),Object.defineProperty(t,"prototype",{writable:!1}),l}(K.DataSourceWithBackend),se=new t.DataSourcePlugin(ue).setConfigEditor(E).setQueryEditor(J)})(),u})()));
//# sourceMappingURL=module.js.map